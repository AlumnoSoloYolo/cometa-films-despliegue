
<div class="admin-container">
  <div class="admin-wrapper">

    <!-- Header del Panel -->
    <div class="admin-header fade-in">
      <h1>Panel de Administraci√≥n</h1>
      <div class="admin-user-info">
        <div class="admin-user-details">
          <span>Bienvenido, <strong>{{ currentUser?.username }}</strong></span>
          @if (userPermissions) {
          <span class="user-role-badge" [ngClass]="'role-' + userPermissions.role">
            {{ userPermissions.role }}
          </span>
          }
        </div>
        <!-- <button class="logout-btn" (click)="logout()">
          Cerrar Sesi√≥n
        </button> -->
      </div>
    </div>

    <!-- Navegaci√≥n Principal -->
    <nav class="admin-nav">
      <button class="nav-tab" [class.active]="tabState.activeTab === 'dashboard'" (click)="showTab('dashboard')">
        Dashboard
      </button>

      <button class="nav-tab" [class.active]="tabState.activeTab === 'users'" (click)="showTab('users')"
        *ngIf="canManageUsers">
        Usuarios
      </button>

      <button class="nav-tab" [class.active]="tabState.activeTab === 'content'" (click)="showTab('content')"
        *ngIf="canModerateContent">
        Contenido
      </button>

      <button class="nav-tab" [class.active]="tabState.activeTab === 'reports'" (click)="showTab('reports')"
        *ngIf="isModerator">
        Reportes
      </button>

      <button class="nav-tab" [class.active]="tabState.activeTab === 'settings'" (click)="showTab('settings')"
        *ngIf="isAdmin">
        Configuraci√≥n
      </button>
    </nav>

    <!-- Dashboard Tab -->
    <div class="tab-content" [class.active]="tabState.activeTab === 'dashboard'">
      @if (loading.stats) {
      <div class="loading">
        Cargando estad√≠sticas...
      </div>
      }

      @if (errors.stats) {
      <div class="error-message">
        {{ errors.stats }}
      </div>
      }

      @if (stats && stats.overview && !loading.stats) {
      <div class="admin-card fade-in">
        <h3>Estad√≠sticas Generales</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number">{{ stats.overview.totalUsers }}</div>
            <div class="stat-label">Total Usuarios</div>
          </div>

          <div class="stat-card">
            <div class="stat-number">{{ stats.overview.activeUsers }}</div>
            <div class="stat-label">Usuarios Activos</div>
          </div>

          <div class="stat-card">
            <div class="stat-number">{{ stats.overview.bannedUsers }}</div>
            <div class="stat-label">Usuarios Baneados</div>
          </div>

          <div class="stat-card">
            <div class="stat-number">{{ stats.overview.totalReviews }}</div>
            <div class="stat-label">Total Rese√±as</div>
          </div>

          <div class="stat-card">
            <div class="stat-number">{{ stats.overview.totalComments }}</div>
            <div class="stat-label">Total Comentarios</div>
          </div>

          <div class="stat-card">
            <div class="stat-number">{{ stats.overview.totalLists }}</div>
            <div class="stat-label">Total Listas</div>
          </div>
        </div>
      </div>

      <!-- Estad√≠sticas de Hoy -->
      <div class="admin-card">
        <h3>Actividad de Hoy</h3>
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-number">{{ stats.today.newUsers }}</div>
            <div class="stat-label">Nuevos Usuarios</div>
          </div>

          <div class="stat-card">
            <div class="stat-number">{{ stats.today.newReviews }}</div>
            <div class="stat-label">Nuevas Rese√±as</div>
          </div>

          <div class="stat-card">
            <div class="stat-number">{{ stats.today.newComments }}</div>
            <div class="stat-label">Nuevos Comentarios</div>
          </div>

          <div class="stat-card">
            <div class="stat-number">{{ stats.today.newLists }}</div>
            <div class="stat-label">Nuevas Listas</div>
          </div>
        </div>
      </div>
      }
    </div>

    <!-- Users Tab -->
    <div class="tab-content" [class.active]="tabState.activeTab === 'users'" *ngIf="canManageUsers">
      <div class="admin-card">
        <h3>Gesti√≥n de Usuarios</h3>

        <!-- Formulario de B√∫squeda Global -->
        <form [formGroup]="userSearchForm" class="search-filters">
          <input type="text" class="search-input" placeholder="Buscar por username o email..." formControlName="search">

          <select class="filter-select" formControlName="role">
            <option value="">Todos los roles</option>
            <option value="admin">Administrador</option>
            <option value="moderator">Moderador</option>
            <option value="premium">Premium</option>
            <option value="user">Usuario</option>
          </select>

          <select class="filter-select" formControlName="status">
            <option value="">Todos los estados</option>
            <option value="active">Activos</option>
            <option value="banned">Baneados</option>
          </select>

          <button type="button" class="search-btn" (click)="searchGlobally()">
            Buscar
          </button>
        </form>

        @if (loading.users && users.length === 0) {
        <div class="loading">
          <div class="loading-spinner"></div>
          <span>Cargando usuarios...</span>
        </div>
        }

        @if (errors.users) {
        <div class="error-message">
          {{ errors.users }}
        </div>
        }

        @if (users.length > 0) {
        <div class="table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Usuario</th>
                <th>Email</th>
                <th>Rol</th>
                <th>Estado</th>
                <th>Registro</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              @for (user of users; track user._id) {
              <tr>
                <td>
                  <div class="flex-center">
                    <img [src]="getUserAvatarPath(user.avatar || 'avatar1')" alt="Avatar" class="user-avatar">
                    <div>
                      <div style="font-weight: 600; color: var(--text-primary);">{{ user.username }}</div>
                      @if (user.biografia) {
                      <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px; line-height: 1.2;">
                        {{ user.biografia.length > 40 ? (user.biografia | slice:0:40) + '...' : user.biografia }}
                      </div>
                      }
                    </div>
                  </div>
                </td>
                <td>
                  <div style="color: var(--text-primary);">{{ user.email }}</div>
                  <!-- @if (user.isPremium) {
                  <div style="margin-top: 4px;">
                    <span class="badge-premium">Premium</span>
                  </div>
                  } -->
                </td>
                <td>
                  <span class="status-badge" [ngClass]="getRoleClass(user.role)">
                    {{ user.role }}
                  </span>
                </td>
                <td>
                  @if (user.isBanned) {
                  <div>
                    <span class="status-badge status-banned">Baneado</span>
                    @if (user.banExpiresAt) {
                    <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 2px; line-height: 1.2;">
                      Expira: {{ formatDate(user.banExpiresAt) }}
                    </div>
                    }
                    @if (user.banReason) {
                    <div style="font-size: 0.7rem; color: var(--color-error); margin-top: 2px; line-height: 1.2;" [title]="user.banReason">
                      {{ user.banReason.length > 25 ? (user.banReason | slice:0:25) + '...' : user.banReason }}
                    </div>
                    }
                  </div>
                  } @else {
                  <span class="status-badge status-active">Activo</span>
                  }
                </td>
                <td>
                  <div style="color: var(--text-primary);">{{ formatDate(user.createdAt) }}</div>
                  @if (user.moderationHistory && user.moderationHistory.length > 0) {
                  <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 2px;">
                    {{ user.moderationHistory.length }} acciones
                  </div>
                  }
                </td>
                <td>
                  <div class="actions-container">
                    @if (!user.isBanned && canBanUsers) {
                    <button class="action-btn btn-warning" (click)="openBanModal(user)"
                      [title]="'Banear a ' + user.username">
                      Ban
                    </button>
                    }

                    @if (user.isBanned && canBanUsers) {
                    <button class="action-btn btn-success" (click)="unbanUser(user)"
                      [title]="'Desbanear a ' + user.username">
                      Unban
                    </button>
                    }

                    @if (isAdmin) {
                    <button class="action-btn btn-primary" (click)="openRoleModal(user)"
                      [title]="'Cambiar rol de ' + user.username">
                      Rol
                    </button>
                    }

                    @if (user.moderationHistory && user.moderationHistory.length > 0) {
                    <button class="action-btn btn-secondary" (click)="openHistoryModal(user)" 
                      [title]="'Ver historial de ' + user.username">
                      Historial
                    </button>
                    }
                  </div>
                </td>
              </tr>
              }
            </tbody>
          </table>
        </div>

        @if (pagination.users.hasMore) {
        <div class="pagination">
          <button class="load-more-btn" [disabled]="loading.users" (click)="loadMoreUsers()">
            @if (loading.users) {
            Cargando...
            } @else {
            Cargar m√°s usuarios
            }
          </button>
        </div>
        }
        } @else if (!loading.users) {
        <div class="empty-state">
          <div class="empty-state-icon">üë•</div>
          <p>No se encontraron usuarios con los filtros aplicados</p>
        </div>
        }
      </div>
    </div>

    <!-- Content Tab - Moderaci√≥n de Contenido -->
    <div class="tab-content" [class.active]="tabState.activeTab === 'content'" *ngIf="canModerateContent">
      <div class="admin-card">
        <h3>Moderaci√≥n de Contenido</h3>

        <!-- Formulario de B√∫squeda Espec√≠fico para Contenido -->
        <form [formGroup]="contentSearchForm" class="search-filters">
          <input type="text" class="search-input" placeholder="Buscar por username del autor..." formControlName="username">

          <select class="filter-select" formControlName="userRole">
            <option value="">Todos los roles</option>
            <option value="admin">Administrador</option>
            <option value="moderator">Moderador</option>
            <option value="premium">Premium</option>
            <option value="user">Usuario</option>
          </select>

          <button type="button" class="search-btn" (click)="searchContent()">
            Buscar Contenido
          </button>

          <button type="button" class="action-btn btn-secondary" (click)="clearContentSearch()" 
            style="height: 44px; min-width: 80px;">
            Limpiar
          </button>
        </form>

        <!-- Sub-navegaci√≥n de contenido -->
        <div class="content-tabs">
          <button class="content-tab" [class.active]="tabState.activeContentTab === 'reviews'"
            (click)="showContentTab('reviews')">
            Rese√±as
            @if (isContentFiltered && filteredReviews.length > 0) {
            <span style="background: var(--color-primary); color: white; border-radius: 12px; padding: 2px 8px; font-size: 0.7rem; margin-left: 4px;">
              {{ filteredReviews.length }}
            </span>
            }
          </button>

          <button class="content-tab" [class.active]="tabState.activeContentTab === 'comments'"
            (click)="showContentTab('comments')">
            Comentarios
            @if (isContentFiltered && filteredComments.length > 0) {
            <span style="background: var(--color-primary); color: white; border-radius: 12px; padding: 2px 8px; font-size: 0.7rem; margin-left: 4px;">
              {{ filteredComments.length }}
            </span>
            }
          </button>

          <button class="content-tab" [class.active]="tabState.activeContentTab === 'lists'"
            (click)="showContentTab('lists')">
            Listas
            @if (isContentFiltered && filteredLists.length > 0) {
            <span style="background: var(--color-primary); color: white; border-radius: 12px; padding: 2px 8px; font-size: 0.7rem; margin-left: 4px;">
              {{ filteredLists.length }}
            </span>
            }
          </button>
        </div>

        <!-- Rese√±as -->
        <div class="tab-content" [class.active]="tabState.activeContentTab === 'reviews'">
          @if (loading.reviews && reviews.length === 0) {
          <div class="loading">
            <div class="loading-spinner"></div>
            <span>Cargando rese√±as...</span>
          </div>
          }

          @if (errors.reviews) {
          <div class="error-message">
            {{ errors.reviews }}
          </div>
          }

          @if (displayReviews.length > 0) {
          <div class="table-container">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Usuario</th>
                  <th>Pel√≠cula</th>
                  <th>Puntuaci√≥n</th>
                  <th>Comentario</th>
                  <th>Fecha</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                @for (review of displayReviews; track review._id) {
                <tr>
                  <td>
                    <div class="flex-center">
                      <img [src]="getUserAvatarPath(review.userId.avatar)" alt="Avatar" class="user-avatar">
                      <div>
                        <div style="font-weight: 600; color: var(--text-primary);">{{ review.userId.username }}</div>
                        <span class="status-badge" [ngClass]="getRoleClass(review.userId.role)"
                          style="font-size: 0.65rem; margin-top: 2px;">
                          {{ review.userId.role }}
                        </span>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div style="font-weight: 600; color: var(--text-primary);">ID: {{ review.movieId }}</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px;">
                      {{ formatDate(review.createdAt) }}
                    </div>
                  </td>
                  <td>
                    <div style="display: flex; align-items: center; gap: 4px;">
                      <span style="color: var(--color-warning); font-weight: 600; font-size: 1rem;">
                        {{ review.rating }}/10
                      </span>
                    </div>
                  </td>
                  <td>
                    <div [title]="review.comment" style="max-width: 250px; line-height: 1.3;">
                      {{ review.comment.length > 80 ? (review.comment | slice:0:80) + '...' : review.comment }}
                    </div>
                    @if (review.comment.length > 80) {
                    <button class="action-btn btn-secondary" (click)="openReviewModal(review)"
                      style="margin-top: 4px; font-size: 0.65rem; padding: 2px 6px; height: 20px; min-width: 40px;">
                      Ver +
                    </button>
                    }
                  </td>
                  <td>
                    <div style="font-size: 0.8rem; color: var(--text-primary);">
                      {{ formatDate(review.createdAt) }}
                    </div>
                  </td>
                  <td>
                    <button class="action-btn btn-danger"
                      (click)="openDeleteModal('review', review._id, 'Rese√±a de ' + review.userId.username)">
                      Eliminar
                    </button>
                  </td>
                </tr>
                }
              </tbody>
            </table>
          </div>

          @if (pagination.reviews.hasMore) {
          <div class="pagination">
            <button class="load-more-btn" [disabled]="loading.reviews" (click)="loadMoreReviews()">
              @if (loading.reviews) {
              Cargando...
              } @else {
              Cargar m√°s rese√±as
              }
            </button>
          </div>
          }
          } @else if (!loading.reviews) {
          <div class="empty-state">
            <div class="empty-state-icon">üìù</div>
            <p>No se encontraron rese√±as para moderar</p>
          </div>
          }
        </div>

        <!-- Comentarios -->
        <div class="tab-content" [class.active]="tabState.activeContentTab === 'comments'">
          @if (loading.comments && comments.length === 0) {
          <div class="loading">
            <div class="loading-spinner"></div>
            <span>Cargando comentarios...</span>
          </div>
          }

          @if (errors.comments) {
          <div class="error-message">
            {{ errors.comments }}
          </div>
          }

          @if (displayComments.length > 0) {
          <div class="table-container">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Usuario</th>
                  <th>Comentario</th>
                  <th>Rese√±a</th>
                  <th>Fecha</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                @for (comment of displayComments; track comment._id) {
                <tr>
                  <td>
                    <div class="flex-center">
                      <img [src]="getUserAvatarPath(comment.userId.avatar)" alt="Avatar" class="user-avatar">
                      <div>
                        <div style="font-weight: 600; color: var(--text-primary);">{{ comment.userId.username }}</div>
                        <span class="status-badge" [ngClass]="getRoleClass(comment.userId.role)"
                          style="font-size: 0.65rem; margin-top: 2px;">
                          {{ comment.userId.role }}
                        </span>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div [title]="comment.text" style="max-width: 250px; line-height: 1.3;">
                      {{ comment.text.length > 80 ? (comment.text | slice:0:80) + '...' : comment.text }}
                    </div>
                    @if (comment.isEdited) {
                    <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 2px;">
                      Editado
                    </div>
                    }
                  </td>
                  <td>
                    <div style="font-size: 0.75rem; color: var(--text-secondary); word-break: break-all;">
                      @if (comment.reviewId && comment.reviewId._id) {
                      <div><strong>ID:</strong> {{ comment.reviewId._id }}</div>
                      @if (comment.reviewId.movieId) {
                      <div><strong>Pel√≠cula:</strong> {{ comment.reviewId.movieId }}</div>
                      }
                      @if (comment.reviewId.userId && comment.reviewId.userId.username) {
                      <div><strong>Autor:</strong> {{ comment.reviewId.userId.username }}</div>
                      }
                      } @else {
                      <div style="color: var(--color-warning);">Rese√±a no encontrada</div>
                      }
                    </div>
                  </td>
                  <td>
                    <div style="font-size: 0.8rem; color: var(--text-primary);">
                      {{ formatDate(comment.createdAt) }}
                    </div>
                  </td>
                  <td>
                    <button class="action-btn btn-danger"
                      (click)="openDeleteModal('comment', comment._id, 'Comentario de ' + comment.userId.username)">
                      Eliminar
                    </button>
                  </td>
                </tr>
                }
              </tbody>
            </table>
          </div>

          @if (pagination.comments.hasMore) {
          <div class="pagination">
            <button class="load-more-btn" [disabled]="loading.comments" (click)="loadMoreComments()">
              @if (loading.comments) {
              Cargando...
              } @else {
              Cargar m√°s comentarios
              }
            </button>
          </div>
          }
          } @else if (!loading.comments) {
          <div class="empty-state">
            <div class="empty-state-icon">üí¨</div>
            <p>No se encontraron comentarios para moderar</p>
          </div>
          }
        </div>

        <!-- Listas -->
        <div class="tab-content" [class.active]="tabState.activeContentTab === 'lists'">
          @if (loading.lists && lists.length === 0) {
          <div class="loading">
            <div class="loading-spinner"></div>
            <span>Cargando listas...</span>
          </div>
          }

          @if (errors.lists) {
          <div class="error-message">
            {{ errors.lists }}
          </div>
          }

          @if (displayLists.length > 0) {
          <div class="table-container">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Usuario</th>
                  <th>T√≠tulo</th>
                  <th>Descripci√≥n</th>
                  <th>Visibilidad</th>
                  <th>Pel√≠culas</th>
                  <th>Fecha</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                @for (list of displayLists; track list._id) {
                <tr>
                  <td>
                    <div class="flex-center">
                      <img [src]="getUserAvatarPath(list.userId.avatar)" alt="Avatar" class="user-avatar">
                      <div>
                        <div style="font-weight: 600; color: var(--text-primary);">{{ list.userId.username }}</div>
                        <span class="status-badge" [ngClass]="getRoleClass(list.userId.role)"
                          style="font-size: 0.65rem; margin-top: 2px;">
                          {{ list.userId.role }}
                        </span>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div style="font-weight: 600; color: var(--text-primary); line-height: 1.3;">{{ list.title }}</div>
                    @if (list.coverImage) {
                    <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 2px;">
                      Con imagen
                    </div>
                    }
                  </td>
                  <td>
                    <div [title]="list.description" style="max-width: 200px; line-height: 1.3;">
                      {{ list.description && list.description.length > 40 ? (list.description | slice:0:40) + '...' :
                      list.description || 'Sin descripci√≥n' }}
                    </div>
                  </td>
                  <td>
                    @if (list.isPublic) {
                    <span class="status-badge status-active">
                      P√∫blica
                    </span>
                    } @else {
                    <span class="status-badge status-banned">
                      Privada
                    </span>
                    }
                  </td>
                  <td>
                    <div style="display: flex; align-items: center; gap: 4px; color: var(--text-primary);">
                      <span style="font-weight: 600;">{{ list.movies.length || 0 }}</span>
                      <span style="font-size: 0.8rem;">films</span>
                    </div>
                  </td>
                  <td>
                    <div style="font-size: 0.8rem; color: var(--text-primary);">
                      {{ formatDate(list.createdAt) }}
                    </div>
                  </td>
                  <td>
                    <button class="action-btn btn-danger" (click)="openDeleteModal('list', list._id, list.title)">
                      Eliminar
                    </button>
                  </td>
                </tr>
                }
              </tbody>
            </table>
          </div>

          @if (pagination.lists.hasMore) {
          <div class="pagination">
            <button class="load-more-btn" [disabled]="loading.lists" (click)="loadMoreLists()">
              @if (loading.lists) {
              Cargando...
              } @else {
              Cargar m√°s listas
              }
            </button>
          </div>
          }
          } @else if (!loading.lists) {
          <div class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <p>No se encontraron listas para moderar</p>
          </div>
          }
        </div>
      </div>
    </div>

    <!-- Reports Tab -->
    <div class="tab-content" [class.active]="tabState.activeTab === 'reports'" *ngIf="isModerator">
      <div class="admin-card">
        <h3>Sistema de Reportes</h3>
        <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
          <div style="font-size: 3rem; margin-bottom: 20px; opacity: 0.3;">üöß</div>
          <p style="font-size: 1.1rem; margin-bottom: 10px;">Funcionalidad de reportes en desarrollo</p>
          <p style="font-size: 0.9rem;">Pr√≥ximamente: Gesti√≥n de reportes de usuarios y contenido</p>
        </div>
      </div>
    </div>

    <!-- Settings Tab -->
    <div class="tab-content" [class.active]="tabState.activeTab === 'settings'" *ngIf="isAdmin">
      <div class="admin-card">
        <h3>Configuraci√≥n del Sistema</h3>
        <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
          <div style="font-size: 3rem; margin-bottom: 20px; opacity: 0.3;">‚öôÔ∏è</div>
          <p style="font-size: 1.1rem; margin-bottom: 10px;">Configuraciones avanzadas en desarrollo</p>
          <p style="font-size: 0.9rem;">Pr√≥ximamente: Configuraci√≥n global del sistema</p>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Modal de Ban -->
@if (showBanModal) {
<div class="modal-overlay" (click)="closeModals()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Banear Usuario</h3>
      <button class="close-btn" (click)="closeModals()">
        √ó
      </button>
    </div>

    <form [formGroup]="banForm" (ngSubmit)="banUser()">
      <div class="form-group">
        <label>Usuario:</label>
        <input type="text" [value]="modalData.username" readonly>
      </div>

      <div class="form-group">
        <label>Raz√≥n del ban: *</label>
        <textarea formControlName="reason" placeholder="Describe la raz√≥n del ban..." required rows="3"></textarea>
        @if (banForm.get('reason')?.errors && banForm.get('reason')?.touched) {
        <div style="color: var(--color-error); font-size: 0.8rem; margin-top: 8px;">
          La raz√≥n es obligatoria y debe tener al menos 10 caracteres
        </div>
        }
      </div>

      <div class="form-group">
        <label>Duraci√≥n del ban:</label>
        <select formControlName="duration">
          <option value="">Permanente (sin expiraci√≥n)</option>
          <option value="1">1 hora (temporal)</option>
          <option value="24">24 horas (1 d√≠a)</option>
          <option value="168">7 d√≠as (1 semana)</option>
          <option value="720">30 d√≠as (1 mes)</option>
        </select>
        <div class="form-help">
          @if (banForm.get('duration')?.value) {
          <span style="color: var(--color-warning);">
            Ban temporal: {{ getBanDurationText(banForm.get('duration')?.value) }}
          </span>
          } @else {
          <span style="color: var(--color-error);">
            Ban permanente: El usuario no podr√° acceder nunca m√°s
          </span>
          }
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="action-btn btn-secondary" (click)="closeModals()">
          Cancelar
        </button>
        <button type="submit" class="action-btn btn-danger" [disabled]="banForm.invalid || loading.banning">
          @if (loading.banning) {
          Baneando...
          } @else {
          Banear Usuario
          }
        </button>
      </div>
    </form>
  </div>
</div>
}

<!-- Modal de Historial de Moderaci√≥n -->
@if (showHistoryModal) {
<div class="modal-overlay" (click)="closeModals()">
  <div class="modal-content modal-history" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Historial de Moderaci√≥n - {{ modalData.username }}</h3>
      <button class="close-btn" (click)="closeModals()">
        √ó
      </button>
    </div>

    @if (modalData.moderationHistory && modalData.moderationHistory.length > 0) {
    <div class="history-list">
      @for (item of modalData.moderationHistory; track $index) {
      <div class="history-item">
        <div class="history-header">
          <span class="history-action">{{ getActionText(item.action) }}</span>
          <span class="history-date">{{ formatDate(item.date) }}</span>
        </div>
        <div class="history-moderator">
          Moderador: <strong>{{ item.moderator }}</strong>
        </div>
        @if (item.reason) {
        <div class="history-reason">
          <strong>Raz√≥n:</strong> {{ item.reason }}
        </div>
        }
        @if (item.duration) {
        <div class="history-reason">
          <strong>Duraci√≥n:</strong> {{ item.duration }}
        </div>
        }
      </div>
      }
    </div>
    } @else {
    <div class="empty-state">
      <div class="empty-state-icon">üìù</div>
      <p>No hay historial de moderaci√≥n para este usuario</p>
    </div>
    }

    <div class="form-actions">
      <button type="button" class="action-btn btn-secondary" (click)="closeModals()">
        Cerrar
      </button>
    </div>
  </div>
</div>
}

<!-- Modal de Ver Rese√±a Completa -->
@if (showReviewModal) {
<div class="modal-overlay" (click)="closeModals()">
  <div class="modal-content modal-large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Rese√±a Completa</h3>
      <button class="close-btn" (click)="closeModals()">
        √ó
      </button>
    </div>

    @if (modalData.review) {
    <div style="margin-bottom: 20px;">
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
        <img [src]="getUserAvatarPath(modalData.review.userId.avatar)" alt="Avatar" class="user-avatar">
        <div>
          <div style="font-weight: 600; color: var(--text-primary);">{{ modalData.review.userId.username }}</div>
          <div style="font-size: 0.8rem; color: var(--text-secondary);">
            {{ formatDate(modalData.review.createdAt) }}
          </div>
        </div>
        <div style="margin-left: auto;">
          <span style="color: var(--color-warning); font-weight: 600; font-size: 1.2rem;">
            {{ modalData.review.rating }}/10
          </span>
        </div>
      </div>

      <div style="margin-bottom: 16px;">
        <strong>Pel√≠cula ID:</strong> {{ modalData.review.movieId }}
      </div>

      <div style="margin-bottom: 16px;">
        <strong>Comentario:</strong>
      </div>

      <div class="review-content">
        {{ modalData.review.comment }}
      </div>
    </div>
    }

    <div class="form-actions">
      <button type="button" class="action-btn btn-secondary" (click)="closeModals()">
        Cerrar
      </button>
      <button type="button" class="action-btn btn-danger" 
        (click)="openDeleteModal('review', modalData.review._id, 'Rese√±a de ' + modalData.review.userId.username)">
        Eliminar Rese√±a
      </button>
    </div>
  </div>
</div>
}

<!-- Modal de Cambio de Rol -->
@if (showRoleModal) {
<div class="modal-overlay" (click)="closeModals()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Cambiar Rol</h3>
      <button class="close-btn" (click)="closeModals()">
        √ó
      </button>
    </div>

    <form [formGroup]="roleForm" (ngSubmit)="changeUserRole()">
      <div class="form-group">
        <label>Usuario:</label>
        <input type="text" [value]="modalData.username" readonly>
      </div>

      <div class="form-group">
        <label>Rol actual:</label>
        <div style="display: flex; align-items: center; gap: 8px;">
          <span class="status-badge" [ngClass]="getRoleClass(modalData.currentRole || '')">
            {{ modalData.currentRole }}
          </span>
        </div>
      </div>

      <div class="form-group">
        <label>Nuevo rol: *</label>
        <select formControlName="newRole" required>
          <option value="">Seleccionar rol</option>
          <option value="user">Usuario</option>
          <option value="premium">Premium</option>
          <option value="moderator">Moderador</option>
          <option value="admin">Administrador</option>
        </select>
        @if (roleForm.get('newRole')?.value) {
        <div class="form-help">
          <span class="status-badge" [ngClass]="getRoleClass(roleForm.get('newRole')?.value)">
            Nuevo rol: {{ roleForm.get('newRole')?.value }}
          </span>
        </div>
        }
      </div>

      <div class="form-group">
        <label>Raz√≥n del cambio:</label>
        <textarea formControlName="reason" placeholder="Raz√≥n para el cambio de rol (opcional)..." rows="2"></textarea>
      </div>

      <div class="form-actions">
        <button type="button" class="action-btn btn-secondary" (click)="closeModals()">
          Cancelar
        </button>
        <button type="submit" class="action-btn btn-primary" [disabled]="roleForm.invalid">
          Cambiar Rol
        </button>
      </div>
    </form>
  </div>
</div>
}

<!-- Modal de Eliminaci√≥n -->
@if (showDeleteModal) {
<div class="modal-overlay" (click)="closeModals()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Eliminar {{ capitalizeFirst(modalData.itemType || '') }}</h3>
      <button class="close-btn" (click)="closeModals()">
        √ó
      </button>
    </div>

    <form [formGroup]="deleteForm" (ngSubmit)="deleteContent()">
      <div style="margin-bottom: 20px;">
        <div style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <span style="color: var(--color-warning);">‚ö†Ô∏è</span>
            <strong style="color: var(--color-warning);">¬øEst√°s seguro de que quieres eliminar?</strong>
          </div>
          <p style="margin: 0; color: var(--text-primary);">{{ modalData.itemTitle }}</p>
        </div>

        <div style="background: rgba(255, 68, 68, 0.1); border: 1px solid rgba(255, 68, 68, 0.3); border-radius: 8px; padding: 12px;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="color: var(--color-error);">‚ùå</span>
            <span style="color: var(--color-error); font-size: 14px; font-weight: 600;">
              Esta acci√≥n no se puede deshacer
            </span>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label>Raz√≥n de la eliminaci√≥n (opcional):</label>
        <textarea formControlName="reason" placeholder="Describe la raz√≥n de la eliminaci√≥n..." rows="3"></textarea>
      </div>

      <div class="form-actions">
        <button type="button" class="action-btn btn-secondary" (click)="closeModals()">
          Cancelar
        </button>
        <button type="submit" class="action-btn btn-danger">
          Eliminar Definitivamente
        </button>
      </div>
    </form>
  </div>
</div>
}