<div class="admin-container">
  <div class="admin-wrapper">

    <!-- Header del Panel -->
    <div class="admin-header fade-in">
      <h1>Panel de Administraci√≥n</h1>
      <div class="admin-user-info">
        <div class="admin-user-details">
          <span>Bienvenido, <strong>{{ currentUser?.username }}</strong></span>
          @if (userPermissions) {
          <span class="user-role-badge" [ngClass]="'role-' + userPermissions.role">
            {{ userPermissions.role }}
          </span>
          }
        </div>
        <!-- <button class="logout-btn" (click)="logout()">
          Cerrar Sesi√≥n
        </button> -->
      </div>
    </div>

    <!-- Navegaci√≥n Principal -->
    <nav class="admin-nav">
      <button class="nav-tab" [class.active]="tabState.activeTab === 'dashboard'" (click)="showTab('dashboard')">
        Dashboard
      </button>

      <button class="nav-tab" [class.active]="tabState.activeTab === 'users'" (click)="showTab('users')"
        *ngIf="canManageUsers">
        Usuarios
      </button>

      <button class="nav-tab" [class.active]="tabState.activeTab === 'content'" (click)="showTab('content')"
        *ngIf="canModerateContent">
        Contenido
      </button>

      <button class="nav-tab" [class.active]="tabState.activeTab === 'reports'" (click)="showTab('reports')"
        *ngIf="isModerator">
        Reportes
      </button>

      <button class="nav-tab" [class.active]="tabState.activeTab === 'settings'" (click)="showTab('settings')"
        *ngIf="isAdmin">
        Configuraci√≥n
      </button>
    </nav>



<!-- Dashboard Tab -  -->
<div class="tab-content" [class.active]="tabState.activeTab === 'dashboard'">
  <div class="dashboard-container">
    <div class="dashboard-wrapper">

      <!-- HEADER MODERNO -->
      <header class="dashboard-header-modern">
        <div class="header-content">
          <div class="header-info">
            <h1 class="dashboard-title">
              <i class="pi pi-chart-line"></i>
              Panel de Control
            </h1>
            <p class="dashboard-subtitle">
              Monitoreo en tiempo real de la plataforma y m√©tricas clave de rendimiento
            </p>
            @if (dashboardData?.generatedAt) {
            <div class="last-update-badge">
              <i class="pi pi-clock"></i>
              <span>Actualizado {{ getLastUpdated() }}</span>
            </div>
            }
          </div>
          
          <div class="header-controls">
            <!-- Selector de tiempo moderno -->
            <div class="time-selector">
              <button 
                class="time-option" 
                [class.active]="selectedTimeRange === 'today'"
                (click)="selectedTimeRange = 'today'; onTimeRangeChange()">
                Hoy
              </button>
              <button 
                class="time-option" 
                [class.active]="selectedTimeRange === 'week'"
                (click)="selectedTimeRange = 'week'; onTimeRangeChange()">
                7 d√≠as
              </button>
              <button 
                class="time-option" 
                [class.active]="selectedTimeRange === 'month'"
                (click)="selectedTimeRange = 'month'; onTimeRangeChange()">
                30 d√≠as
              </button>
            </div>
            
            <!-- Bot√≥n de actualizar -->
            <button 
              class="modern-button"
              [disabled]="loading.dashboard"
              (click)="refreshDashboard()">
              <i class="pi" [class.pi-refresh]="!loading.dashboard" [class.pi-spin]="loading.dashboard" [class.pi-spinner]="loading.dashboard"></i>
              {{ loading.dashboard ? 'Cargando...' : 'Actualizar' }}
            </button>
          </div>
        </div>
      </header>

      <!-- ESTADO DE CARGA -->
      @if (loading.dashboard && !dashboardData) {
      <div class="dashboard-section">
        <div class="metrics-grid">
          <div class="loading-skeleton skeleton-metric"></div>
          <div class="loading-skeleton skeleton-metric"></div>
          <div class="loading-skeleton skeleton-metric"></div>
          <div class="loading-skeleton skeleton-metric"></div>
        </div>
        <div class="charts-grid">
          <div class="loading-skeleton skeleton-chart"></div>
          <div class="loading-skeleton skeleton-chart"></div>
        </div>
      </div>
      }

      <!-- ERROR STATE -->
      @if (hasError && !dashboardData) {
      <div class="dashboard-section">
        <div class="alert-item danger">
          <div class="alert-icon danger">
            <i class="pi pi-exclamation-triangle"></i>
          </div>
          <div class="alert-content">
            <div class="alert-title">Error al cargar el dashboard</div>
            <div class="alert-description">
              {{ errors.dashboard || 'Error desconocido' }}
              <button class="modern-button" (click)="refreshDashboard()" style="margin-left: 1rem;">
                Reintentar
              </button>
            </div>
          </div>
        </div>
      </div>
      }

      <!-- CONTENIDO PRINCIPAL DEL DASHBOARD -->
      @if (dashboardData) {

      <!-- SECCI√ìN 1: M√âTRICAS PRINCIPALES -->
      <section class="dashboard-section">
        <div class="section-header">
          <div>
            <h2 class="section-title">
              <i class="pi pi-chart-bar"></i>
              M√©tricas Principales
            </h2>
            <p class="section-subtitle">Indicadores clave de rendimiento en tiempo real</p>
          </div>
        </div>

        <div class="metrics-grid">
          <!-- M√©trica de Moderaci√≥n -->
          <div class="metric-card priority">
            <div class="metric-icon priority">
              <i class="pi pi-shield"></i>
            </div>
            <div class="metric-value">{{ dashboardData.moderation.pendingReports }}</div>
            <div class="metric-label">Reportes Pendientes</div>
            <div class="metric-stats">
              <div class="metric-change" [class.positive]="dashboardData.today.newReports === 0" [class.negative]="dashboardData.today.newReports > 0">
                <i class="pi" [class.pi-arrow-up]="dashboardData.today.newReports > 0" [class.pi-check]="dashboardData.today.newReports === 0"></i>
                <span>{{ dashboardData.today.newReports }} nuevos hoy</span>
              </div>
              <div class="metric-secondary">{{ moderationEfficiency }}% eficiencia</div>
            </div>
          </div>

          <!-- M√©trica de Usuarios -->
          <div class="metric-card users">
            <div class="metric-icon users">
              <i class="pi pi-users"></i>
            </div>
            <div class="metric-value">{{ formatNumber(dashboardData.overview.totalUsers) }}</div>
            <div class="metric-label">Total Usuarios</div>
            <div class="metric-stats">
              <div class="metric-change positive">
                <i class="pi pi-arrow-up"></i>
                <span>+{{ dashboardData.today.newUsers }} hoy</span>
              </div>
              <div class="metric-secondary">{{ dashboardData.overview.premiumUsers }} premium</div>
            </div>
          </div>

          <!-- M√©trica de Actividad -->
          <div class="metric-card activity">
            <div class="metric-icon activity">
              <i class="pi pi-chart-line"></i>
            </div>
            <div class="metric-value">{{ formatNumber(dashboardData.today.newReviews + dashboardData.today.newComments) }}</div>
            <div class="metric-label">Interacciones Hoy</div>
            <div class="metric-stats">
              <div class="metric-change" [class.positive]="activityGrowthPercentage > 0" [class.negative]="activityGrowthPercentage < 0">
                <i class="pi" [class.pi-arrow-up]="activityGrowthPercentage > 0" [class.pi-arrow-down]="activityGrowthPercentage < 0"></i>
                <span>{{ formatPercentage(activityGrowthPercentage) }}</span>
              </div>
              <div class="metric-secondary">vs. promedio semanal</div>
            </div>
          </div>

          <!-- M√©trica de Engagement -->
          <div class="metric-card engagement">
            <div class="metric-icon engagement">
              <i class="pi pi-heart"></i>
            </div>
            <div class="metric-value">{{ formatNumber(dashboardData.today.totalLikes) }}</div>
            <div class="metric-label">Likes Hoy</div>
            <div class="metric-stats">
              <div class="metric-change positive">
                <i class="pi pi-star"></i>
                <span>{{ dashboardData.content.averageRating.toFixed(1) }}/10 rating</span>
              </div>
              <div class="metric-secondary">{{ realtimeMetrics?.activeUsersNow || 0 }} activos</div>
            </div>
          </div>
        </div>
      </section>

      <!-- SECCI√ìN 2: GR√ÅFICAS -->
      @if (canShowCharts) {
      <section class="dashboard-section">
        <div class="section-header">
          <div>
            <h2 class="section-title">
              <i class="pi pi-chart-pie"></i>
              An√°lisis y Tendencias
            </h2>
            <p class="section-subtitle">Visualizaci√≥n de datos y patrones de comportamiento</p>
          </div>
        </div>

        <div class="charts-grid">
          <!-- Gr√°fica Principal -->
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">
                <i class="pi pi-trending-up"></i>
                Crecimiento de Usuarios
              </h3>
            </div>
            <div class="chart-container">
              @if (userGrowthChartData && !loading.charts) {
              <p-chart 
                type="line" 
                [data]="userGrowthChartData" 
                [options]="userGrowthChartOptions"
                height="300px">
              </p-chart>
              } @else {
              <div class="chart-placeholder">
                <i class="pi pi-chart-line"></i>
                <span>Cargando gr√°fica...</span>
              </div>
              }
            </div>
          </div>

          <!-- Gr√°fica Secundaria -->
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">
                <i class="pi pi-chart-pie"></i>
                Distribuci√≥n
              </h3>
            </div>
            <div class="chart-container">
              @if (contentDistributionChartData && !loading.charts) {
              <p-chart 
                type="doughnut" 
                [data]="contentDistributionChartData" 
                [options]="contentDistributionChartOptions"
                height="250px">
              </p-chart>
              } @else {
              <div class="chart-placeholder">
                <i class="pi pi-chart-pie"></i>
                <span>Cargando distribuci√≥n...</span>
              </div>
              }
            </div>
          </div>
        </div>
      </section>
      }


      <section class="dashboard-section">
        <div class="section-header">
          <div>
            <h2 class="section-title">
              <i class="pi pi-chart-bar"></i>
              Tendencias de Actividad
            </h2>
            <p class="section-subtitle">Evoluci√≥n de rese√±as, comentarios y engagement por per√≠odo</p>
          </div>
          <div class="header-controls">
            <button class="modern-button secondary" (click)="exportActivityData()">
              <i class="pi pi-download"></i>
              Exportar
            </button>
          </div>
        </div>

        <div class="charts-grid">
          <!-- Gr√°fica de Barras de Actividad -->
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">
                <i class="pi pi-chart-bar"></i>
                Actividad por Per√≠odo
              </h3>
              @if (loading.charts) {
              <div class="loading-skeleton" style="width: 80px; height: 4px;"></div>
              }
            </div>
            <div class="chart-container">
              @if (activityTrendsChartData && !loading.charts) {
              <p-chart 
                type="bar" 
                [data]="activityTrendsChartData" 
                [options]="activityTrendsChartOptions"
                height="300px">
              </p-chart>
              } @else {
              <div class="chart-placeholder">
                <i class="pi pi-chart-bar"></i>
                <span>Cargando tendencias de actividad...</span>
              </div>
              }
            </div>
          </div>

          <!-- M√©tricas de Actividad -->
          <div class="chart-card">
            <div class="chart-header">
              <h3 class="chart-title">
                <i class="pi pi-trending-up"></i>
                M√©tricas de Engagement
              </h3>
            </div>
            <div class="chart-container" style="padding: var(--spacing-lg);">
              
              <!-- M√©tricas en Grid -->
              <div class="activity-metrics-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg); margin-bottom: var(--spacing-xl);">
                
                <!-- Rese√±as del Per√≠odo -->
                <div class="activity-metric-item">
                  <div class="activity-metric-icon" style="background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));">
                    <i class="pi pi-comment"></i>
                  </div>
                  <div class="activity-metric-data">
                    <div class="activity-metric-number">{{ formatNumber(dashboardData.period.newReviews) }}</div>
                    <div class="activity-metric-label">Rese√±as del Per√≠odo</div>
                    <div class="activity-metric-change" [class.positive]="getReviewTrend() > 0" [class.negative]="getReviewTrend() < 0">
                      <i class="pi" [class.pi-arrow-up]="getReviewTrend() > 0" [class.pi-arrow-down]="getReviewTrend() < 0"></i>
                      <span>{{ formatPercentage(getReviewTrend()) }} vs anterior</span>
                    </div>
                  </div>
                </div>

                <!-- Comentarios del Per√≠odo -->
                <div class="activity-metric-item">
                  <div class="activity-metric-icon" style="background: linear-gradient(135deg, var(--color-success), #059669);">
                    <i class="pi pi-comments"></i>
                  </div>
                  <div class="activity-metric-data">
                    <div class="activity-metric-number">{{ formatNumber(dashboardData.period.newComments) }}</div>
                    <div class="activity-metric-label">Comentarios del Per√≠odo</div>
                    <div class="activity-metric-change" [class.positive]="getCommentTrend() > 0" [class.negative]="getCommentTrend() < 0">
                      <i class="pi" [class.pi-arrow-up]="getCommentTrend() > 0" [class.pi-arrow-down]="getCommentTrend() < 0"></i>
                      <span>{{ formatPercentage(getCommentTrend()) }} vs anterior</span>
                    </div>
                  </div>
                </div>

                <!-- Likes del Per√≠odo -->
                <div class="activity-metric-item">
                  <div class="activity-metric-icon" style="background: linear-gradient(135deg, var(--color-accent), var(--color-accent-light));">
                    <i class="pi pi-heart-fill"></i>
                  </div>
                  <div class="activity-metric-data">
                    <div class="activity-metric-number">{{ formatNumber(dashboardData.period.totalLikes || (dashboardData.today.totalLikes * getPeriodMultiplier())) }}</div>
                    <div class="activity-metric-label">Likes del Per√≠odo</div>
                    <div class="activity-metric-change positive">
                      <i class="pi pi-heart"></i>
                      <span>{{ getLikesPerDay() }} promedio/d√≠a</span>
                    </div>
                  </div>
                </div>

                <!-- Engagement Rate -->
                <div class="activity-metric-item">
                  <div class="activity-metric-icon" style="background: linear-gradient(135deg, var(--color-warning), #d97706);">
                    <i class="pi pi-chart-line"></i>
                  </div>
                  <div class="activity-metric-data">
                    <div class="activity-metric-number">{{ getEngagementRate() }}%</div>
                    <div class="activity-metric-label">Tasa de Engagement</div>
                    <div class="activity-metric-change" [class.positive]="getEngagementRate() > 70" [class.negative]="getEngagementRate() < 50">
                      <i class="pi pi-percentage"></i>
                      <span>{{ getEngagementRate() > 70 ? 'Excelente' : getEngagementRate() > 50 ? 'Bueno' : 'Mejorable' }}</span>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Resumen de Actividad -->
              <div class="activity-summary" style="background: var(--bg-surface); padding: var(--spacing-lg); border-radius: var(--radius-lg); border: var(--border-width) solid var(--border-color);">
                <div class="activity-summary-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--spacing-md);">
                  <h4 style="margin: 0; color: var(--text-primary); font-size: var(--font-size-base); font-weight: var(--font-weight-semibold);">
                    <i class="pi pi-chart-line" style="color: var(--color-primary); margin-right: var(--spacing-sm);"></i>
                    Resumen de Actividad
                  </h4>
                  <div class="activity-score-badge" style="background: var(--gradient-accent); color: white; padding: var(--spacing-xs) var(--spacing-md); border-radius: var(--radius-3xl); font-weight: var(--font-weight-bold); font-size: var(--font-size-sm);">
                    Score: {{ getActivityScore() }}/100
                  </div>
                </div>
                
                <div class="activity-insights" style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg);">
                  <div>
                    <div style="font-size: var(--font-size-sm); color: var(--text-secondary); margin-bottom: var(--spacing-xs);">D√≠a m√°s activo:</div>
                    <div style="font-weight: var(--font-weight-semibold); color: var(--text-primary);">{{ getMostActiveDay() }}</div>
                  </div>
                  <div>
                    <div style="font-size: var(--font-size-sm); color: var(--text-secondary); margin-bottom: var(--spacing-xs);">Promedio diario:</div>
                    <div style="font-weight: var(--font-weight-semibold); color: var(--text-primary);">{{ getDailyAverage() }} interacciones</div>
                  </div>
                </div>
              </div>

            </div>
          </div>
        </div>
      </section>

      <!-- SECCI√ìN 3: CONTENIDO POPULAR -->
      @if (topMovies.length > 0) {
      <section class="dashboard-section">
        <div class="section-header">
          <div>
            <h2 class="section-title">
              <i class="pi pi-star"></i>
              Contenido M√°s Popular
            </h2>
            <p class="section-subtitle">Las pel√≠culas con mayor engagement del per√≠odo seleccionado</p>
          </div>
          <div class="header-controls">
            <button class="modern-button secondary" (click)="viewAllPopularMovies()">
              <i class="pi pi-external-link"></i>
              Ver Todo
            </button>
            <button class="modern-button secondary" (click)="exportPopularMovies()">
              <i class="pi pi-download"></i>
              Exportar
            </button>
          </div>
        </div>

        <div class="movies-section">
          <div class="movies-grid">
            @for (movie of topMovies; track movie.movieId) {
            <div class="movie-card" (click)="viewMovieDetails(movie.movieId)">
              <div class="movie-rank">#{{ $index + 1 }}</div>
              
              <div class="movie-poster">
            
                <img 
                  [src]="getMoviePoster(movie.movieId)" 
                  [alt]="movie.title || 'Pel√≠cula ' + movie.movieId"
                  style="width: 100%; height: 100%; object-fit: cover; border-radius: var(--border-radius);"
                 >
              </div>
              
              <h4 class="movie-title">
                {{ movie.title || 'Pel√≠cula ID: ' + movie.movieId }}
              </h4>
              
              <div class="movie-stats">
                <div class="movie-stat">
                  <span>Rating</span>
                  <span class="movie-stat-value">{{ movie.averageRating.toFixed(1) }}/10</span>
                </div>
                <div class="movie-stat">
                  <span>Rese√±as</span>
                  <span class="movie-stat-value">{{ formatNumber(movie.reviewCount) }}</span>
                </div>
                <!-- @if (movie.totalLikes) {
                <div class="movie-stat">
                  <span>Likes</span>
                  <span class="movie-stat-value">{{ formatNumber(movie.totalLikes) }}</span>
                </div>
                } -->
                @if (movie.trendingScore) {
                <div class="movie-stat">
                  <span>Tendencia</span>
                  <span class="movie-stat-value">+{{ movie.trendingScore }}%</span>
                </div>
                }
              </div>
            </div>
            }
          </div>
        </div>
      </section>
      }

      <!-- SECCI√ìN 4: ALERTAS Y SISTEMA -->
      <section class="dashboard-section">
        <div class="content-grid">
          <!-- Alertas del Sistema -->
          <div class="alerts-section">
            <div class="section-header">
              <h3 class="section-title">
                <i class="pi pi-bell"></i>
                Alertas del Sistema
              </h3>
            </div>

            <!-- Alerta de reportes pendientes -->
            @if (dashboardData.moderation.pendingReports > 10) {
            <div class="alert-item warning">
              <div class="alert-icon warning">
                <i class="pi pi-exclamation-triangle"></i>
              </div>
              <div class="alert-content">
                <div class="alert-title">Alto volumen de reportes</div>
                <div class="alert-description">
                  {{ dashboardData.moderation.pendingReports }} reportes esperando revisi√≥n
                </div>
              </div>
            </div>
            }

            <!-- Alerta de actividad elevada -->
            @if (dashboardData.today.newBans > 5) {
            <div class="alert-item info">
              <div class="alert-icon info">
                <i class="pi pi-info-circle"></i>
              </div>
              <div class="alert-content">
                <div class="alert-title">Actividad de moderaci√≥n elevada</div>
                <div class="alert-description">
                  {{ dashboardData.today.newBans }} usuarios baneados hoy
                </div>
              </div>
            </div>
            }

            <!-- Alerta de crecimiento -->
            @if (userGrowthPercentage > 50) {
            <div class="alert-item success">
              <div class="alert-icon success">
                <i class="pi pi-check-circle"></i>
              </div>
              <div class="alert-content">
                <div class="alert-title">üéâ Crecimiento excepcional</div>
                <div class="alert-description">
                  {{ userGrowthPercentage }}% por encima del promedio
                </div>
              </div>
            </div>
            }

            <!-- Estado saludable -->
            @if (
              dashboardData.moderation.pendingReports <= 10 &&
              dashboardData.today.newBans <= 5 &&
              userGrowthPercentage <= 50
            ) {
            <div class="alert-item success">
              <div class="alert-icon success">
                <i class="pi pi-check-circle"></i>
              </div>
              <div class="alert-content">
                <div class="alert-title">‚úÖ Sistema funcionando correctamente</div>
                <div class="alert-description">
                  No hay alertas cr√≠ticas en este momento
                </div>
              </div>
            </div>
            }
          </div>

          <!-- Estad√≠sticas de Moderaci√≥n -->
          <div class="alerts-section">
            <div class="section-header">
              <h3 class="section-title">
                <i class="pi pi-shield"></i>
                Estado de Moderaci√≥n
              </h3>
            </div>

            <div class="metric-stats" style="flex-direction: column; gap: var(--spacing-lg); padding: 0; border: none;">
              <div class="flex justify-between items-center" style="width: 100%;">
                <div>
                  <div class="font-semibold text-lg">{{ dashboardData.moderation.pendingReports }}</div>
                  <div class="text-sm opacity-75">Reportes pendientes</div>
                </div>
                <div class="text-right">
                  <div class="font-semibold text-lg">{{ formatTime(dashboardData.moderation.averageResolutionTime) }}</div>
                  <div class="text-sm opacity-75">Tiempo promedio</div>
                </div>
              </div>

              <div class="flex justify-between items-center" style="width: 100%;">
                <div>
                  <div class="font-semibold text-lg">{{ dashboardData.period.newReports - dashboardData.moderation.pendingReports }}</div>
                  <div class="text-sm opacity-75">Resueltos</div>
                </div>
                <div class="text-right">
                  <div class="font-semibold text-lg">{{ moderationEfficiency }}%</div>
                  <div class="text-sm opacity-75">Eficiencia</div>
                </div>
              </div>

              <div style="margin-top: var(--spacing-md);">
                <div class="text-sm opacity-75 mb-2">Tipo m√°s com√∫n:</div>
                <div class="font-semibold">{{ getReasonDisplayText(dashboardData.moderation.mostCommonReportType) }}</div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- SECCI√ìN 5: ACCIONES R√ÅPIDAS -->
      <section class="dashboard-section">
        <div class="section-header">
          <div>
            <h2 class="section-title">
              <i class="pi pi-bolt"></i>
              Acciones R√°pidas
            </h2>
            <p class="section-subtitle">Acceso directo a las funciones m√°s utilizadas</p>
          </div>
        </div>

        <div class="quick-actions-grid">
          <!-- Revisar Reportes -->
          <div class="action-card reports" (click)="navigateToReports()">
            @if (dashboardData.moderation.pendingReports > 0) {
            <div class="action-badge">{{ dashboardData.moderation.pendingReports }}</div>
            }
            <div class="action-icon-wrapper reports">
              <i class="pi pi-flag"></i>
            </div>
            <h4 class="action-title">Revisar Reportes</h4>
            <p class="action-description">Gestionar reportes pendientes de moderaci√≥n</p>
          </div>

          <!-- Gestionar Usuarios -->
          <div class="action-card users" (click)="navigateToUsers()">
            <div class="action-icon-wrapper users">
              <i class="pi pi-users"></i>
            </div>
            <h4 class="action-title">Gestionar Usuarios</h4>
            <p class="action-description">Administrar cuentas y permisos de usuarios</p>
          </div>

          <!-- Moderar Contenido -->
          <div class="action-card content" (click)="navigateToContent()">
            <div class="action-icon-wrapper content">
              <i class="pi pi-file-text"></i>
            </div>
            <h4 class="action-title">Moderar Contenido</h4>
            <p class="action-description">Revisar rese√±as, comentarios y listas</p>
          </div>

          <!-- Actualizar Datos -->
          <div class="action-card refresh" (click)="refreshDashboard()">
            <div class="action-icon-wrapper refresh">
              <i class="pi pi-refresh"></i>
            </div>
            <h4 class="action-title">Actualizar Datos</h4>
            <p class="action-description">Refrescar todas las m√©tricas del sistema</p>
          </div>
        </div>
      </section>

      } <!-- Fin del @if (dashboardData) -->

      <!-- FALLBACK: Estad√≠sticas b√°sicas si no hay datos avanzados -->
      @if (!dashboardData && stats && !loading.dashboard) {
      <section class="dashboard-section">
        <div class="alerts-section">
          <div class="section-header">
            <h3 class="section-title">
              <i class="pi pi-chart-bar"></i>
              Estad√≠sticas B√°sicas del Sistema
            </h3>
          </div>

          <div class="metrics-grid">
            <div class="metric-card">
              <div class="metric-value">{{ stats.overview.totalUsers }}</div>
              <div class="metric-label">Total Usuarios</div>
            </div>

            <div class="metric-card">
              <div class="metric-value">{{ stats.overview.totalReviews }}</div>
              <div class="metric-label">Total Rese√±as</div>
            </div>

            <div class="metric-card">
              <div class="metric-value">{{ stats.overview.totalComments }}</div>
              <div class="metric-label">Total Comentarios</div>
            </div>

            <div class="metric-card">
              <div class="metric-value">{{ stats.today.newUsers }}</div>
              <div class="metric-label">Nuevos Usuarios Hoy</div>
            </div>
          </div>

          <div class="alert-item info" style="margin-top: var(--spacing-xl);">
            <div class="alert-icon info">
              <i class="pi pi-info-circle"></i>
            </div>
            <div class="alert-content">
              <div class="alert-title">üìä Dashboard Mejorado Disponible</div>
              <div class="alert-description">
                Actualiza el backend para acceder a m√©tricas avanzadas, gr√°ficas interactivas y alertas en tiempo real.
              </div>
            </div>
          </div>
        </div>
      </section>
      }

    </div>
  </div>
</div>

    <!-- Users Tab -->
    <div class="tab-content" [class.active]="tabState.activeTab === 'users'" *ngIf="canManageUsers">
      <div class="admin-card">
        <h3>Gesti√≥n de Usuarios</h3>

        <!-- Formulario de B√∫squeda Global -->
        <form [formGroup]="userSearchForm" class="search-filters">
          <input type="text" class="search-input" placeholder="Buscar por username o email..." formControlName="search">

          <select class="filter-select" formControlName="role">
            <option value="">Todos los roles</option>
            <option value="admin">Administrador</option>
            <option value="moderator">Moderador</option>
            <option value="premium">Premium</option>
            <option value="user">Usuario</option>
          </select>

          <select class="filter-select" formControlName="status">
            <option value="">Todos los estados</option>
            <option value="active">Activos</option>
            <option value="banned">Baneados</option>
          </select>

          <button type="button" class="search-btn" (click)="searchGlobally()">
            Buscar
          </button>
        </form>

        @if (loading.users && users.length === 0) {
        <div class="loading">
          <div class="loading-spinner"></div>
          <span>Cargando usuarios...</span>
        </div>
        }

        @if (errors.users) {
        <div class="error-message">
          {{ errors.users }}
        </div>
        }

        @if (users.length > 0) {
        <div class="table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Usuario</th>
                <th>Email</th>
                <th>Rol</th>
                <th>Estado</th>
                <th>Registro</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              @for (user of users; track user._id) {
              <tr>
                <td>
                  <div class="flex-center">
                    <img [src]="getUserAvatarPath(user.avatar || 'avatar1')" alt="Avatar" class="user-avatar">
                    <div>
                      <div style="font-weight: 600; color: var(--text-primary);">{{ user.username }}</div>
                      @if (user.biografia) {
                      <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px; line-height: 1.2;">
                        {{ user.biografia.length > 40 ? (user.biografia | slice:0:40) + '...' : user.biografia }}
                      </div>
                      }
                    </div>
                  </div>
                </td>
                <td>
                  <div style="color: var(--text-primary);">{{ user.email }}</div>
                  <!-- @if (user.isPremium) {
                  <div style="margin-top: 4px;">
                    <span class="badge-premium">Premium</span>
                  </div>
                  } -->
                </td>
                <td>
                  <span class="status-badge" [ngClass]="getRoleClass(user.role)">
                    {{ user.role }}
                  </span>
                </td>
                <td>
                  @if (user.isBanned) {
                  <div>
                    <span class="status-badge status-banned">Baneado</span>
                    @if (user.banExpiresAt) {
                    <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 2px; line-height: 1.2;">
                      Expira: {{ formatDate(user.banExpiresAt) }}
                    </div>
                    }
                    @if (user.banReason) {
                    <div style="font-size: 0.7rem; color: var(--color-error); margin-top: 2px; line-height: 1.2;"
                      [title]="user.banReason">
                      {{ user.banReason.length > 25 ? (user.banReason | slice:0:25) + '...' : user.banReason }}
                    </div>
                    }
                  </div>
                  } @else {
                  <span class="status-badge status-active">Activo</span>
                  }
                </td>
                <td>
                  <div style="color: var(--text-primary);">{{ formatDate(user.createdAt) }}</div>
                  @if (user.moderationHistory && user.moderationHistory.length > 0) {
                  <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 2px;">
                    {{ user.moderationHistory.length }} acciones
                  </div>
                  }
                </td>
                <td>
                  <div class="actions-container">
                    @if (!user.isBanned && canBanUsers) {
                    <button class="action-btn btn-warning" (click)="openBanModal(user)"
                      [title]="'Banear a ' + user.username">
                      Ban
                    </button>
                    }

                    @if (user.isBanned && canBanUsers) {
                    <button class="action-btn btn-success" (click)="unbanUser(user)"
                      [title]="'Desbanear a ' + user.username">
                      Unban
                    </button>
                    }

                    @if (isAdmin) {
                    <button class="action-btn btn-primary" (click)="openRoleModal(user)"
                      [title]="'Cambiar rol de ' + user.username">
                      Rol
                    </button>
                    }

                    @if (user.moderationHistory && user.moderationHistory.length > 0) {
                    <button class="action-btn btn-secondary" (click)="openHistoryModal(user)"
                      [title]="'Ver historial de ' + user.username">
                      Historial
                    </button>
                    }
                  </div>
                </td>
              </tr>
              }
            </tbody>
          </table>
        </div>

        @if (pagination.users.hasMore) {
        <div class="pagination">
          <button class="load-more-btn" [disabled]="loading.users" (click)="loadMoreUsers()">
            @if (loading.users) {
            Cargando...
            } @else {
            Cargar m√°s usuarios
            }
          </button>
        </div>
        }
        } @else if (!loading.users) {
        <div class="empty-state">
          <div class="empty-state-icon">üë•</div>
          <p>No se encontraron usuarios con los filtros aplicados</p>
        </div>
        }
      </div>
    </div>

    <!-- Content Tab - Moderaci√≥n de Contenido -->
    <div class="tab-content" [class.active]="tabState.activeTab === 'content'" *ngIf="canModerateContent">
      <div class="admin-card">
        <h3>Moderaci√≥n de Contenido</h3>

        <!-- Formulario de B√∫squeda Espec√≠fico para Contenido -->
        <form [formGroup]="contentSearchForm" class="search-filters">
          <input type="text" class="search-input" placeholder="Buscar por username del autor..."
            formControlName="username">

          <select class="filter-select" formControlName="userRole">
            <option value="">Todos los roles</option>
            <option value="admin">Administrador</option>
            <option value="moderator">Moderador</option>
            <option value="premium">Premium</option>
            <option value="user">Usuario</option>
          </select>

          <button type="button" class="search-btn" (click)="searchContent()">
            Buscar Contenido
          </button>

          <button type="button" class="action-btn btn-secondary" (click)="clearContentSearch()"
            style="height: 44px; min-width: 80px;">
            Limpiar
          </button>
        </form>

        <!-- Sub-navegaci√≥n de contenido -->
        <div class="content-tabs">
          <button class="content-tab" [class.active]="tabState.activeContentTab === 'reviews'"
            (click)="showContentTab('reviews')">
            Rese√±as
            @if (isContentFiltered && filteredReviews.length > 0) {
            <span
              style="background: var(--color-primary); color: white; border-radius: 12px; padding: 2px 8px; font-size: 0.7rem; margin-left: 4px;">
              {{ filteredReviews.length }}
            </span>
            }
          </button>

          <button class="content-tab" [class.active]="tabState.activeContentTab === 'comments'"
            (click)="showContentTab('comments')">
            Comentarios
            @if (isContentFiltered && filteredComments.length > 0) {
            <span
              style="background: var(--color-primary); color: white; border-radius: 12px; padding: 2px 8px; font-size: 0.7rem; margin-left: 4px;">
              {{ filteredComments.length }}
            </span>
            }
          </button>

          <button class="content-tab" [class.active]="tabState.activeContentTab === 'lists'"
            (click)="showContentTab('lists')">
            Listas
            @if (isContentFiltered && filteredLists.length > 0) {
            <span
              style="background: var(--color-primary); color: white; border-radius: 12px; padding: 2px 8px; font-size: 0.7rem; margin-left: 4px;">
              {{ filteredLists.length }}
            </span>
            }
          </button>
        </div>

        <!-- Rese√±as -->
        <div class="tab-content" [class.active]="tabState.activeContentTab === 'reviews'">
          @if (loading.reviews && reviews.length === 0) {
          <div class="loading">
            <div class="loading-spinner"></div>
            <span>Cargando rese√±as...</span>
          </div>
          }

          @if (errors.reviews) {
          <div class="error-message">
            {{ errors.reviews }}
          </div>
          }

          @if (displayReviews.length > 0) {
          <div class="table-container">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Usuario</th>
                  <th>Pel√≠cula</th>
                  <th>Puntuaci√≥n</th>
                  <th>Comentario</th>
                  <th>Fecha</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                @for (review of displayReviews; track review._id) {
                <tr>
                  <td>
                    <div class="flex-center">
                      <img [src]="getUserAvatarPath(review.userId.avatar)" alt="Avatar" class="user-avatar">
                      <div>
                        <div style="font-weight: 600; color: var(--text-primary);">{{ review.userId.username }}</div>
                        <span class="status-badge" [ngClass]="getRoleClass(review.userId.role)"
                          style="font-size: 0.65rem; margin-top: 2px;">
                          {{ review.userId.role }}
                        </span>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div style="font-weight: 600; color: var(--text-primary);">ID: {{ review.movieId }}</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px;">
                      {{ formatDate(review.createdAt) }}
                    </div>
                  </td>
                  <td>
                    <div style="display: flex; align-items: center; gap: 4px;">
                      <span style="color: var(--color-warning); font-weight: 600; font-size: 1rem;">
                        {{ review.rating }}/10
                      </span>
                    </div>
                  </td>
                  <td>
                    <div [title]="review.comment" style="max-width: 250px; line-height: 1.3;">
                      {{ review.comment.length > 80 ? (review.comment | slice:0:80) + '...' : review.comment }}
                    </div>
                    @if (review.comment.length > 80) {
                    <button class="action-btn btn-secondary" (click)="openReviewModal(review)"
                      style="margin-top: 4px; font-size: 0.65rem; padding: 2px 6px; height: 20px; min-width: 40px;">
                      Ver +
                    </button>
                    }
                  </td>
                  <td>
                    <div style="font-size: 0.8rem; color: var(--text-primary);">
                      {{ formatDate(review.createdAt) }}
                    </div>
                  </td>
                  <td>
                    <button class="action-btn btn-danger"
                      (click)="openDeleteModal('review', review._id, 'Rese√±a de ' + review.userId.username)">
                      Eliminar
                    </button>
                  </td>
                </tr>
                }
              </tbody>
            </table>
          </div>

          @if (pagination.reviews.hasMore) {
          <div class="pagination">
            <button class="load-more-btn" [disabled]="loading.reviews" (click)="loadMoreReviews()">
              @if (loading.reviews) {
              Cargando...
              } @else {
              Cargar m√°s rese√±as
              }
            </button>
          </div>
          }
          } @else if (!loading.reviews) {
          <div class="empty-state">
            <div class="empty-state-icon">üìù</div>
            <p>No se encontraron rese√±as para moderar</p>
          </div>
          }
        </div>

        <!-- Comentarios -->
        <div class="tab-content" [class.active]="tabState.activeContentTab === 'comments'">
          @if (loading.comments && comments.length === 0) {
          <div class="loading">
            <div class="loading-spinner"></div>
            <span>Cargando comentarios...</span>
          </div>
          }

          @if (errors.comments) {
          <div class="error-message">
            {{ errors.comments }}
          </div>
          }

          @if (displayComments.length > 0) {
          <div class="table-container">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Usuario</th>
                  <th>Comentario</th>
                  <th>Rese√±a</th>
                  <th>Fecha</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                @for (comment of displayComments; track comment._id) {
                <tr>
                  <td>
                    <div class="flex-center">
                      <img [src]="getUserAvatarPath(comment.userId.avatar)" alt="Avatar" class="user-avatar">
                      <div>
                        <div style="font-weight: 600; color: var(--text-primary);">{{ comment.userId.username }}</div>
                        <span class="status-badge" [ngClass]="getRoleClass(comment.userId.role)"
                          style="font-size: 0.65rem; margin-top: 2px;">
                          {{ comment.userId.role }}
                        </span>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div [title]="comment.text" style="max-width: 250px; line-height: 1.3;">
                      {{ comment.text.length > 80 ? (comment.text | slice:0:80) + '...' : comment.text }}
                    </div>
                    @if (comment.isEdited) {
                    <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 2px;">
                      Editado
                    </div>
                    }
                  </td>
                  <td>
                    <div style="font-size: 0.75rem; color: var(--text-secondary); word-break: break-all;">
                      @if (comment.reviewId && comment.reviewId._id) {
                      <div><strong>ID:</strong> {{ comment.reviewId._id }}</div>
                      @if (comment.reviewId.movieId) {
                      <div><strong>Pel√≠cula:</strong> {{ comment.reviewId.movieId }}</div>
                      }
                      @if (comment.reviewId.userId && comment.reviewId.userId.username) {
                      <div><strong>Autor:</strong> {{ comment.reviewId.userId.username }}</div>
                      }
                      } @else {
                      <div style="color: var(--color-warning);">Rese√±a no encontrada</div>
                      }
                    </div>
                  </td>
                  <td>
                    <div style="font-size: 0.8rem; color: var(--text-primary);">
                      {{ formatDate(comment.createdAt) }}
                    </div>
                  </td>
                  <td>
                    <button class="action-btn btn-danger"
                      (click)="openDeleteModal('comment', comment._id, 'Comentario de ' + comment.userId.username)">
                      Eliminar
                    </button>
                  </td>
                </tr>
                }
              </tbody>
            </table>
          </div>

          @if (pagination.comments.hasMore) {
          <div class="pagination">
            <button class="load-more-btn" [disabled]="loading.comments" (click)="loadMoreComments()">
              @if (loading.comments) {
              Cargando...
              } @else {
              Cargar m√°s comentarios
              }
            </button>
          </div>
          }
          } @else if (!loading.comments) {
          <div class="empty-state">
            <div class="empty-state-icon">üí¨</div>
            <p>No se encontraron comentarios para moderar</p>
          </div>
          }
        </div>

        <!-- Listas -->
        <div class="tab-content" [class.active]="tabState.activeContentTab === 'lists'">
          @if (loading.lists && lists.length === 0) {
          <div class="loading">
            <div class="loading-spinner"></div>
            <span>Cargando listas...</span>
          </div>
          }

          @if (errors.lists) {
          <div class="error-message">
            {{ errors.lists }}
          </div>
          }

          @if (displayLists.length > 0) {
          <div class="table-container">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Usuario</th>
                  <th>T√≠tulo</th>
                  <th>Descripci√≥n</th>
                  <th>Visibilidad</th>
                  <th>Pel√≠culas</th>
                  <th>Fecha</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                @for (list of displayLists; track list._id) {
                <tr>
                  <td>
                    <div class="flex-center">
                      <img [src]="getUserAvatarPath(list.userId.avatar)" alt="Avatar" class="user-avatar">
                      <div>
                        <div style="font-weight: 600; color: var(--text-primary);">{{ list.userId.username }}</div>
                        <span class="status-badge" [ngClass]="getRoleClass(list.userId.role)"
                          style="font-size: 0.65rem; margin-top: 2px;">
                          {{ list.userId.role }}
                        </span>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div style="font-weight: 600; color: var(--text-primary); line-height: 1.3;">{{ list.title }}</div>
                    @if (list.coverImage) {
                    <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 2px;">
                      Con imagen
                    </div>
                    }
                  </td>
                  <td>
                    <div [title]="list.description" style="max-width: 200px; line-height: 1.3;">
                      {{ list.description && list.description.length > 40 ? (list.description | slice:0:40) + '...' :
                      list.description || 'Sin descripci√≥n' }}
                    </div>
                  </td>
                  <td>
                    @if (list.isPublic) {
                    <span class="status-badge status-active">
                      P√∫blica
                    </span>
                    } @else {
                    <span class="status-badge status-banned">
                      Privada
                    </span>
                    }
                  </td>
                  <td>
                    <div style="display: flex; align-items: center; gap: 4px; color: var(--text-primary);">
                      <span style="font-weight: 600;">{{ list.movies.length || 0 }}</span>
                      <span style="font-size: 0.8rem;">films</span>
                    </div>
                  </td>
                  <td>
                    <div style="font-size: 0.8rem; color: var(--text-primary);">
                      {{ formatDate(list.createdAt) }}
                    </div>
                  </td>
                  <td>
                    <button class="action-btn btn-danger" (click)="openDeleteModal('list', list._id, list.title)">
                      Eliminar
                    </button>
                  </td>
                </tr>
                }
              </tbody>
            </table>
          </div>

          @if (pagination.lists.hasMore) {
          <div class="pagination">
            <button class="load-more-btn" [disabled]="loading.lists" (click)="loadMoreLists()">
              @if (loading.lists) {
              Cargando...
              } @else {
              Cargar m√°s listas
              }
            </button>
          </div>
          }
          } @else if (!loading.lists) {
          <div class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <p>No se encontraron listas para moderar</p>
          </div>
          }
        </div>
      </div>
    </div>

    <!-- Contenido de la pesta√±a Reports -->
    <div class="tab-content" [class.active]="tabState.activeTab === 'reports'" *ngIf="isModerator">
      <div class="admin-card">
        <h3>Sistema de Reportes</h3>

        <!-- Estad√≠sticas de reportes -->
        @if (reportStats) {
        <div class="reports-stats-grid">
          <div class="stat-card">
            <div class="stat-number">{{ reportStats.summary.total }}</div>
            <div class="stat-label">Total Reportes</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">{{ reportStats.summary.pending }}</div>
            <div class="stat-label">Pendientes</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">{{ reportStats.summary.underReview }}</div>
            <div class="stat-label">En Revisi√≥n</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">{{ reportStats.summary.resolved }}</div>
            <div class="stat-label">Resueltos</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">{{ reportStats.summary.resolutionRate }}%</div>
            <div class="stat-label">Tasa de Resoluci√≥n</div>
          </div>
        </div>
        }

        <!-- Filtros de reportes -->
        <form [formGroup]="reportSearchForm" class="search-filters">
          <select class="filter-select" formControlName="status">
            <option value="">Todos los estados</option>
            <option value="pending">Pendientes</option>
            <option value="under_review">En revisi√≥n</option>
            <option value="resolved">Resueltos</option>
            <option value="dismissed">Descartados</option>
          </select>

          <select class="filter-select" formControlName="priority">
            <option value="">Todas las prioridades</option>
            <option value="urgent">Urgente</option>
            <option value="high">Alta</option>
            <option value="medium">Media</option>
            <option value="low">Baja</option>
          </select>

          <select class="filter-select" formControlName="contentType">
            <option value="">Todos los tipos</option>
            <option value="user">Perfil de usuario</option>
            <option value="review">Rese√±a</option>
            <option value="comment">Comentario</option>
            <option value="list">Lista</option>
          </select>

          <select class="filter-select" formControlName="category">
            <option value="">Todas las categor√≠as</option>
            <option value="content">Contenido</option>
            <option value="behavior">Comportamiento</option>
            <option value="spam">Spam</option>
            <option value="legal">Legal</option>
            <option value="safety">Seguridad</option>
          </select>

          <button type="button" class="search-btn" (click)="searchReports()">
            Buscar
          </button>

          <button type="button" class="action-btn btn-secondary" (click)="clearReportSearch()">
            Limpiar
          </button>
        </form>

        @if (loading.reports && reports.length === 0) {
        <div class="loading">
          <div class="loading-spinner"></div>
          <span>Cargando reportes...</span>
        </div>
        }

        @if (errors.reports) {
        <div class="error-message">
          {{ errors.reports }}
        </div>
        }

        @if (reports.length > 0) {
        <div class="reports-table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Reporter</th>
                <th>Usuario Reportado</th>
                <th>Contenido</th>
                <th>Motivo</th>
                <th>Prioridad</th>
                <th>Estado</th>
                <th>Fecha</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              @for (report of reports; track report._id) {
              <tr>
                <!-- Reporter -->
                <td>
                  <div class="flex-center">
                    <img [src]="getUserAvatarPath(report.reporter.avatar)" alt="Avatar" class="user-avatar">
                    <div>
                      <div style="font-weight: 600; color: var(--text-primary);">{{ report.reporter.username }}</div>
                      <span class="status-badge" [ngClass]="getRoleClass(report.reporter.role)"
                        style="font-size: 0.65rem; margin-top: 2px;">
                        {{ report.reporter.role }}
                      </span>
                    </div>
                  </div>
                </td>

                <!-- Usuario reportado -->
                <td>
                  <div class="flex-center">
                    <img [src]="getUserAvatarPath(report.reportedUser.avatar)" alt="Avatar" class="user-avatar">
                    <div>
                      <div style="font-weight: 600; color: var(--text-primary);">{{ report.reportedUser.username }}
                      </div>
                      <span class="status-badge" [ngClass]="getRoleClass(report.reportedUser.role)"
                        style="font-size: 0.65rem; margin-top: 2px;">
                        {{ report.reportedUser.role }}
                      </span>
                    </div>
                  </div>
                </td>

                <!-- Contenido reportado -->
                <td>
                  <div>
                    <div style="font-weight: 600; color: var(--text-primary);">
                      {{ getContentTypeDisplayText(report.reportedContent.contentType) }}
                    </div>
                    @if (report.reportedContent.contentSnapshot) {
                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px; line-height: 1.3;">
                      @if (report.reportedContent.contentSnapshot.title) {
                      <div><strong>T√≠tulo:</strong> {{ report.reportedContent.contentSnapshot.title }}</div>
                      }
                      @if (report.reportedContent.contentSnapshot.text) {
                      <div><strong>Texto:</strong> {{ (report.reportedContent.contentSnapshot.text | slice:0:60) + '...'
                        }}
                      </div>
                      }
                      @if (report.reportedContent.contentSnapshot.rating) {
                      <div><strong>Puntuaci√≥n:</strong> {{ report.reportedContent.contentSnapshot.rating }}/10</div>
                      }
                    </div>
                    }
                  </div>
                </td>

                <!-- Motivo -->
                <td>
                  <div style="max-width: 150px;">
                    <div style="font-weight: 600; color: var(--text-primary); font-size: 0.85rem;">
                      {{ getReasonDisplayText(report.reason) }}
                    </div>
                    @if (report.description) {
                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px; line-height: 1.3;"
                      [title]="report.description">
                      {{ (report.description | slice:0:50) + (report.description.length > 50 ? '...' : '') }}
                    </div>
                    }
                  </div>
                </td>

                <!-- Prioridad -->
                <td>
                  <span class="priority-badge" [ngClass]="getPriorityClass(report.priority)">
                    {{ capitalizeFirst(report.priority) }}
                  </span>
                </td>

                <!-- Estado -->
                <td>
                  <span class="status-badge" [ngClass]="getReportStatusClass(report.status)">
                    {{ getStatusDisplayText(report.status) }}
                  </span>
                  @if (report.resolution && report.resolution.resolvedBy) {
                  <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 2px;">
                    Por: {{ report.resolution.resolvedBy.username }}
                  </div>
                  }
                </td>

                <!-- Fecha -->
                <td>
                  <div style="font-size: 0.8rem; color: var(--text-primary);">
                    {{ formatDate(report.createdAt) }}
                  </div>
                  @if (report.resolution && report.resolution.resolvedAt) {
                  <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 2px;">
                    Resuelto: {{ formatDate(report.resolution.resolvedAt) }}
                  </div>
                  }
                </td>

                <!-- Acciones -->
                <td>
                  <div class="actions-container">
                    @if (report.status === 'pending') {
                    <button class="action-btn btn-warning" (click)="updateReportStatus(report._id, 'under_review')"
                      title="Marcar en revisi√≥n">
                      <i class="bi bi-eye"></i>
                    </button>
                    }

                    @if (report.status !== 'resolved') {
                    <button class="action-btn btn-primary" (click)="openResolveReportModal(report)"
                      title="Resolver reporte">
                      <i class="bi bi-check-lg"></i>
                    </button>
                    }

                    @if (report.status !== 'dismissed') {
                    <button class="action-btn btn-secondary" (click)="updateReportStatus(report._id, 'dismissed')"
                      title="Descartar reporte">
                      <i class="bi bi-x-lg"></i>
                    </button>
                    }

                    <button class="action-btn btn-secondary" (click)="openReportDetailModal(report)"
                      title="Ver detalles">
                      <i class="bi bi-info-circle"></i>
                    </button>
                  </div>
                </td>
              </tr>
              }
            </tbody>
          </table>
        </div>

        @if (pagination.reports.hasMore) {
        <div class="pagination">
          <button class="load-more-btn" [disabled]="loading.reports" (click)="loadMoreReports()">
            @if (loading.reports) {
            Cargando...
            } @else {
            Cargar m√°s reportes
            }
          </button>
        </div>
        }
        } @else if (!loading.reports) {
        <div class="empty-state">
          <div class="empty-state-icon">üö©</div>
          <p>No se encontraron reportes</p>
        </div>
        }
      </div>
    </div>

    <!-- Settings Tab -->
    <div class="tab-content" [class.active]="tabState.activeTab === 'settings'" *ngIf="isAdmin">
      <div class="admin-card">
        <h3>Configuraci√≥n del Sistema</h3>
        <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
          <div style="font-size: 3rem; margin-bottom: 20px; opacity: 0.3;">‚öôÔ∏è</div>
          <p style="font-size: 1.1rem; margin-bottom: 10px;">Configuraciones avanzadas en desarrollo</p>
          <p style="font-size: 0.9rem;">Pr√≥ximamente: Configuraci√≥n global del sistema</p>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Modal de Ban -->
@if (showBanModal) {
<div class="modal-overlay" (click)="closeModals()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Banear Usuario</h3>
      <button class="close-btn" (click)="closeModals()">
        √ó
      </button>
    </div>

    <form [formGroup]="banForm" (ngSubmit)="banUser()">
      <div class="form-group">
        <label>Usuario:</label>
        <input type="text" [value]="modalData.username" readonly>
      </div>

      <div class="form-group">
        <label>Raz√≥n del ban: *</label>
        <textarea formControlName="reason" placeholder="Describe la raz√≥n del ban..." required rows="3"></textarea>
        @if (banForm.get('reason')?.errors && banForm.get('reason')?.touched) {
        <div style="color: var(--color-error); font-size: 0.8rem; margin-top: 8px;">
          La raz√≥n es obligatoria y debe tener al menos 10 caracteres
        </div>
        }
      </div>

      <div class="form-group">
        <label>Duraci√≥n del ban:</label>
        <select formControlName="duration">
          <option value="">Permanente (sin expiraci√≥n)</option>
          <option value="1">1 hora (temporal)</option>
          <option value="24">24 horas (1 d√≠a)</option>
          <option value="168">7 d√≠as (1 semana)</option>
          <option value="720">30 d√≠as (1 mes)</option>
        </select>
        <div class="form-help">
          @if (banForm.get('duration')?.value) {
          <span style="color: var(--color-warning);">
            Ban temporal: {{ getBanDurationText(banForm.get('duration')?.value) }}
          </span>
          } @else {
          <span style="color: var(--color-error);">
            Ban permanente: El usuario no podr√° acceder nunca m√°s
          </span>
          }
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="action-btn btn-secondary" (click)="closeModals()">
          Cancelar
        </button>
        <button type="submit" class="action-btn btn-danger" [disabled]="banForm.invalid || loading.banning">
          @if (loading.banning) {
          Baneando...
          } @else {
          Banear Usuario
          }
        </button>
      </div>
    </form>
  </div>
</div>
}




<!-- Modal para resolver reporte -->
@if (showResolveReportModal) {
<div class="modal-overlay" (click)="closeReportModals()">
  <div class="modal-content modal-large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Resolver Reporte</h3>
      <button class="close-btn" (click)="closeReportModals()">
        √ó
      </button>
    </div>

    <form [formGroup]="resolveReportForm" (ngSubmit)="resolveReport()">
      @if (modalData.report) {
      <!-- Informaci√≥n del reporte -->
      <div
        style="background: var(--bg-surface); padding: var(--spacing-lg); border-radius: var(--radius-md); margin-bottom: var(--spacing-lg);">
        <div
          style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg); margin-bottom: var(--spacing-md);">
          <div>
            <strong>Reporter:</strong> {{ modalData.report.reporter.username }}
          </div>
          <div>
            <strong>Usuario reportado:</strong> {{ modalData.report.reportedUser.username }}
          </div>
        </div>

        <div
          style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg); margin-bottom: var(--spacing-md);">
          <div>
            <strong>Tipo:</strong> {{ getContentTypeDisplayText(modalData.report.reportedContent.contentType) }}
          </div>
          <div>
            <strong>Motivo:</strong> {{ getReasonDisplayText(modalData.report.reason) }}
          </div>
        </div>

        @if (modalData.report.description) {
        <div style="margin-bottom: var(--spacing-md);">
          <strong>Descripci√≥n:</strong>
          <div
            style="background: var(--bg-input); padding: var(--spacing-sm); border-radius: var(--radius-sm); margin-top: var(--spacing-xs);">
            {{ modalData.report.description }}
          </div>
        </div>
        }

        @if (modalData.report.reportedContent.contentSnapshot) {
        <div>
          <strong>Contenido reportado:</strong>
          <div
            style="background: var(--bg-input); padding: var(--spacing-sm); border-radius: var(--radius-sm); margin-top: var(--spacing-xs);">
            @if (modalData.report.reportedContent.contentSnapshot.title) {
            <div><strong>T√≠tulo:</strong> {{ modalData.report.reportedContent.contentSnapshot.title }}</div>
            }
            @if (modalData.report.reportedContent.contentSnapshot.text) {
            <div><strong>Texto:</strong> {{ modalData.report.reportedContent.contentSnapshot.text }}</div>
            }
            @if (modalData.report.reportedContent.contentSnapshot.rating) {
            <div><strong>Puntuaci√≥n:</strong> {{ modalData.report.reportedContent.contentSnapshot.rating }}/10</div>
            }
          </div>
        </div>
        }
      </div>
      }

      <div class="form-group">
        <label>Acci√≥n a tomar: *</label>
        <select formControlName="action" required>
          <option value="">Seleccionar acci√≥n</option>
          <option value="no_action">Sin acci√≥n</option>
          <option value="content_deleted">Contenido eliminado</option>
          <option value="user_warned">Usuario advertido</option>
          <option value="user_banned">Usuario baneado</option>
          <option value="other">Otra acci√≥n</option>
        </select>
      </div>

      <div class="form-group">
        <label>Notas de resoluci√≥n:</label>
        <textarea formControlName="notes" placeholder="Describe la acci√≥n tomada y el motivo..." rows="4"></textarea>
      </div>

      <div class="form-group">
        <label style="display: flex; align-items: center; gap: var(--spacing-sm);">
          <input type="checkbox" formControlName="shouldNotify" style="margin: 0;">
          Enviar notificaci√≥n al usuario reportado
        </label>
      </div>

      <div class="form-actions">
        <button type="button" class="action-btn btn-secondary" (click)="closeReportModals()">
          Cancelar
        </button>
        <button type="submit" class="action-btn btn-primary"
          [disabled]="resolveReportForm.invalid || loading.resolvingReport">
          @if (loading.resolvingReport) {
          Resolviendo...
          } @else {
          Resolver Reporte
          }
        </button>
      </div>
    </form>
  </div>
</div>
}

<!-- Modal para ver detalles del reporte -->
@if (showReportDetailModal) {
<div class="modal-overlay" (click)="closeReportModals()">
  <div class="modal-content modal-large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Detalles del Reporte</h3>
      <button class="close-btn" (click)="closeReportModals()">
        √ó
      </button>
    </div>

    @if (modalData.report) {
    <div style="padding: var(--spacing-lg);">
      <!-- Informaci√≥n b√°sica -->
      <div
        style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg); margin-bottom: var(--spacing-xl);">
        <div>
          <h4>Reporter</h4>
          <div class="flex-center" style="gap: var(--spacing-md);">
            <img [src]="getUserAvatarPath(modalData.report.reporter.avatar)" alt="Avatar" class="user-avatar">
            <div>
              <div style="font-weight: 600;">{{ modalData.report.reporter.username }}</div>
              <span class="status-badge" [ngClass]="getRoleClass(modalData.report.reporter.role)">
                {{ modalData.report.reporter.role }}
              </span>
            </div>
          </div>
        </div>

        <div>
          <h4>Usuario Reportado</h4>
          <div class="flex-center" style="gap: var(--spacing-md);">
            <img [src]="getUserAvatarPath(modalData.report.reportedUser.avatar)" alt="Avatar" class="user-avatar">
            <div>
              <div style="font-weight: 600;">{{ modalData.report.reportedUser.username }}</div>
              <span class="status-badge" [ngClass]="getRoleClass(modalData.report.reportedUser.role)">
                {{ modalData.report.reportedUser.role }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Detalles del reporte -->
      <div style="margin-bottom: var(--spacing-xl);">
        <h4>Detalles del Reporte</h4>
        <div style="background: var(--bg-surface); padding: var(--spacing-lg); border-radius: var(--radius-md);">
          <div
            style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--spacing-lg); margin-bottom: var(--spacing-md);">
            <div>
              <strong>Tipo:</strong> {{ getContentTypeDisplayText(modalData.report.reportedContent.contentType) }}
            </div>
            <div>
              <strong>Motivo:</strong> {{ getReasonDisplayText(modalData.report.reason) }}
            </div>
            <div>
              <strong>Prioridad:</strong>
              <span class="priority-badge" [ngClass]="getPriorityClass(modalData.report.priority)">
                {{ capitalizeFirst(modalData.report.priority) }}
              </span>
            </div>
          </div>

          <div style="margin-bottom: var(--spacing-md);">
            <strong>Estado:</strong>
            <span class="status-badge" [ngClass]="getReportStatusClass(modalData.report.status)">
              {{ getStatusDisplayText(modalData.report.status) }}
            </span>
          </div>

          @if (modalData.report.description) {
          <div style="margin-bottom: var(--spacing-md);">
            <strong>Descripci√≥n del reporter:</strong>
            <div
              style="background: var(--bg-input); padding: var(--spacing-sm); border-radius: var(--radius-sm); margin-top: var(--spacing-xs);">
              {{ modalData.report.description }}
            </div>
          </div>
          }

          <div style="margin-bottom: var(--spacing-md);">
            <strong>Fecha del reporte:</strong> {{ formatDate(modalData.report.createdAt) }}
          </div>
        </div>
      </div>

      <!-- Contenido reportado -->
      @if (modalData.report.reportedContent.contentSnapshot) {
      <div style="margin-bottom: var(--spacing-xl);">
        <h4>Contenido Reportado</h4>
        <div style="background: var(--bg-surface); padding: var(--spacing-lg); border-radius: var(--radius-md);">
          @if (modalData.report.reportedContent.contentSnapshot.title) {
          <div style="margin-bottom: var(--spacing-sm);">
            <strong>T√≠tulo:</strong> {{ modalData.report.reportedContent.contentSnapshot.title }}
          </div>
          }
          @if (modalData.report.reportedContent.contentSnapshot.text) {
          <div style="margin-bottom: var(--spacing-sm);">
            <strong>Texto:</strong>
            <div
              style="background: var(--bg-input); padding: var(--spacing-sm); border-radius: var(--radius-sm); margin-top: var(--spacing-xs); white-space: pre-wrap;">
              {{ modalData.report.reportedContent.contentSnapshot.text }}</div>
          </div>
          }
          @if (modalData.report.reportedContent.contentSnapshot.rating) {
          <div style="margin-bottom: var(--spacing-sm);">
            <strong>Puntuaci√≥n:</strong> {{ modalData.report.reportedContent.contentSnapshot.rating }}/10
          </div>
          }
        </div>
      </div>
      }

      <!-- Resoluci√≥n (si existe) -->
      @if (modalData.report.resolution) {
      <div>
        <h4>Resoluci√≥n</h4>
        <div style="background: var(--bg-surface); padding: var(--spacing-lg); border-radius: var(--radius-md);">
          <div style="margin-bottom: var(--spacing-sm);">
            <strong>Acci√≥n:</strong> {{ getActionDisplayText(modalData.report.resolution.action) }}
          </div>
          <div style="margin-bottom: var(--spacing-sm);">
            <strong>Resuelto por:</strong> {{ modalData.report.resolution.resolvedBy.username }}
          </div>
          <div style="margin-bottom: var(--spacing-sm);">
            <strong>Fecha de resoluci√≥n:</strong> {{ formatDate(modalData.report.resolution.resolvedAt) }}
          </div>
          @if (modalData.report.resolution.notes) {
          <div>
            <strong>Notas:</strong>
            <div
              style="background: var(--bg-input); padding: var(--spacing-sm); border-radius: var(--radius-sm); margin-top: var(--spacing-xs);">
              {{ modalData.report.resolution.notes }}
            </div>
          </div>
          }
        </div>
      </div>
      }
    </div>
    }

    <div class="form-actions">
      <button type="button" class="action-btn btn-secondary" (click)="closeReportModals()">
        Cerrar
      </button>
    </div>
  </div>
</div>
}

<!-- Modal de Historial de Moderaci√≥n -->
@if (showHistoryModal) {
<div class="modal-overlay" (click)="closeModals()">
  <div class="modal-content modal-history" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Historial de Moderaci√≥n - {{ modalData.username }}</h3>
      <button class="close-btn" (click)="closeModals()">
        √ó
      </button>
    </div>

    @if (modalData.moderationHistory && modalData.moderationHistory.length > 0) {
    <div class="history-list">
      @for (item of modalData.moderationHistory; track $index) {
      <div class="history-item">
        <div class="history-header">
          <span class="history-action">{{ getActionText(item.action) }}</span>
          <span class="history-date">{{ formatDate(item.date) }}</span>
        </div>
        <div class="history-moderator">
          Moderador: <strong>{{ item.moderator }}</strong>
        </div>
        @if (item.reason) {
        <div class="history-reason">
          <strong>Raz√≥n:</strong> {{ item.reason }}
        </div>
        }
        @if (item.duration) {
        <div class="history-reason">
          <strong>Duraci√≥n:</strong> {{ item.duration }}
        </div>
        }
      </div>
      }
    </div>
    } @else {
    <div class="empty-state">
      <div class="empty-state-icon">üìù</div>
      <p>No hay historial de moderaci√≥n para este usuario</p>
    </div>
    }

    <div class="form-actions">
      <button type="button" class="action-btn btn-secondary" (click)="closeModals()">
        Cerrar
      </button>
    </div>
  </div>
</div>
}

<!-- Modal de Ver Rese√±a Completa -->
@if (showReviewModal) {
<div class="modal-overlay" (click)="closeModals()">
  <div class="modal-content modal-large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Rese√±a Completa</h3>
      <button class="close-btn" (click)="closeModals()">
        √ó
      </button>
    </div>

    @if (modalData.review) {
    <div style="margin-bottom: 20px;">
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
        <img [src]="getUserAvatarPath(modalData.review.userId.avatar)" alt="Avatar" class="user-avatar">
        <div>
          <div style="font-weight: 600; color: var(--text-primary);">{{ modalData.review.userId.username }}</div>
          <div style="font-size: 0.8rem; color: var(--text-secondary);">
            {{ formatDate(modalData.review.createdAt) }}
          </div>
        </div>
        <div style="margin-left: auto;">
          <span style="color: var(--color-warning); font-weight: 600; font-size: 1.2rem;">
            {{ modalData.review.rating }}/10
          </span>
        </div>
      </div>

      <div style="margin-bottom: 16px;">
        <strong>Pel√≠cula ID:</strong> {{ modalData.review.movieId }}
      </div>

      <div style="margin-bottom: 16px;">
        <strong>Comentario:</strong>
      </div>

      <div class="review-content">
        {{ modalData.review.comment }}
      </div>
    </div>
    }

    <div class="form-actions">
      <button type="button" class="action-btn btn-secondary" (click)="closeModals()">
        Cerrar
      </button>
      <button type="button" class="action-btn btn-danger"
        (click)="openDeleteModal('review', modalData.review._id, 'Rese√±a de ' + modalData.review.userId.username)">
        Eliminar Rese√±a
      </button>
    </div>
  </div>
</div>
}

<!-- Modal de Cambio de Rol -->
@if (showRoleModal) {
<div class="modal-overlay" (click)="closeModals()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Cambiar Rol</h3>
      <button class="close-btn" (click)="closeModals()">
        √ó
      </button>
    </div>

    <form [formGroup]="roleForm" (ngSubmit)="changeUserRole()">
      <div class="form-group">
        <label>Usuario:</label>
        <input type="text" [value]="modalData.username" readonly>
      </div>

      <div class="form-group">
        <label>Rol actual:</label>
        <div style="display: flex; align-items: center; gap: 8px;">
          <span class="status-badge" [ngClass]="getRoleClass(modalData.currentRole || '')">
            {{ modalData.currentRole }}
          </span>
        </div>
      </div>

      <div class="form-group">
        <label>Nuevo rol: *</label>
        <select formControlName="newRole" required>
          <option value="">Seleccionar rol</option>
          <option value="user">Usuario</option>
          <option value="premium">Premium</option>
          <option value="moderator">Moderador</option>
          <option value="admin">Administrador</option>
        </select>
        @if (roleForm.get('newRole')?.value) {
        <div class="form-help">
          <span class="status-badge" [ngClass]="getRoleClass(roleForm.get('newRole')?.value)">
            Nuevo rol: {{ roleForm.get('newRole')?.value }}
          </span>
        </div>
        }
      </div>

      <div class="form-group">
        <label>Raz√≥n del cambio:</label>
        <textarea formControlName="reason" placeholder="Raz√≥n para el cambio de rol (opcional)..." rows="2"></textarea>
      </div>

      <div class="form-actions">
        <button type="button" class="action-btn btn-secondary" (click)="closeModals()">
          Cancelar
        </button>
        <button type="submit" class="action-btn btn-primary" [disabled]="roleForm.invalid">
          Cambiar Rol
        </button>
      </div>
    </form>
  </div>
</div>
}

<!-- Modal de Eliminaci√≥n -->
@if (showDeleteModal) {
<div class="modal-overlay" (click)="closeModals()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Eliminar {{ capitalizeFirst(modalData.itemType || '') }}</h3>
      <button class="close-btn" (click)="closeModals()">
        √ó
      </button>
    </div>

    <form [formGroup]="deleteForm" (ngSubmit)="deleteContent()">
      <div style="margin-bottom: 20px;">
        <div
          style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <span style="color: var(--color-warning);">‚ö†Ô∏è</span>
            <strong style="color: var(--color-warning);">¬øEst√°s seguro de que quieres eliminar?</strong>
          </div>
          <p style="margin: 0; color: var(--text-primary);">{{ modalData.itemTitle }}</p>
        </div>

        <div
          style="background: rgba(255, 68, 68, 0.1); border: 1px solid rgba(255, 68, 68, 0.3); border-radius: 8px; padding: 12px;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="color: var(--color-error);">‚ùå</span>
            <span style="color: var(--color-error); font-size: 14px; font-weight: 600;">
              Esta acci√≥n no se puede deshacer
            </span>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label>Raz√≥n de la eliminaci√≥n (opcional):</label>
        <textarea formControlName="reason" placeholder="Describe la raz√≥n de la eliminaci√≥n..." rows="3"></textarea>
      </div>

      <div class="form-actions">
        <button type="button" class="action-btn btn-secondary" (click)="closeModals()">
          Cancelar
        </button>
        <button type="submit" class="action-btn btn-danger">
          Eliminar
        </button>
      </div>
    </form>
  </div>
</div>
}