<div class="admin-container">
  <div class="admin-wrapper">

    <!-- Header del Panel -->
    <div class="admin-header fade-in">
      <h1>Panel de Administraci√≥n</h1>
      <div class="admin-user-info">
        <div class="admin-user-details">
          <span>Bienvenido, <strong>{{ currentUser?.username }}</strong></span>
          @if (userPermissions) {
          <span class="user-role-badge" [ngClass]="'role-' + userPermissions.role">
            {{ userPermissions.role }}
          </span>
          }
        </div>
        <!-- <button class="logout-btn" (click)="logout()">
          Cerrar Sesi√≥n
        </button> -->
      </div>
    </div>

    <!-- Navegaci√≥n Principal -->
    <nav class="admin-nav">
      <button class="nav-tab" [class.active]="tabState.activeTab === 'dashboard'" (click)="showTab('dashboard')">
        Dashboard
      </button>

      <button class="nav-tab" [class.active]="tabState.activeTab === 'users'" (click)="showTab('users')"
        *ngIf="canManageUsers">
        Usuarios
      </button>

      <button class="nav-tab" [class.active]="tabState.activeTab === 'content'" (click)="showTab('content')"
        *ngIf="canModerateContent">
        Contenido
      </button>

      <button class="nav-tab" [class.active]="tabState.activeTab === 'reports'" (click)="showTab('reports')"
        *ngIf="isModerator">
        Reportes
      </button>

      <button class="nav-tab" [class.active]="tabState.activeTab === 'settings'" (click)="showTab('settings')"
        *ngIf="isAdmin">
        Configuraci√≥n
      </button>
    </nav>

   <!-- ==========================================
     PASO 4: REEMPLAZAR EL CONTENIDO DEL DASHBOARD TAB 
     en src/app/components/admin-panel/admin-panel/admin-panel.component.html
     ========================================== -->

<!-- Dashboard Tab - REEMPLAZAR solo esta secci√≥n -->
<div class="tab-content" [class.active]="tabState.activeTab === 'dashboard'">

  <!-- Header del Dashboard -->
  <div class="dashboard-header-prime">
    <p-toolbar styleClass="border-noround">
      <ng-template pTemplate="start">
        <div class="dashboard-title-section">
          <h2 class="dashboard-main-title">
            <i class="pi pi-chart-line mr-2"></i>
            Dashboard de Administraci√≥n
          </h2>
          <p class="dashboard-subtitle">
            Vista general de la actividad y salud de la plataforma
            @if (dashboardData?.generatedAt) {
            <span class="last-updated">
              ‚Ä¢ √öltima actualizaci√≥n: {{ getLastUpdated() }}
            </span>
            }
          </p>
        </div>
      </ng-template>

      <ng-template pTemplate="end">
        <div class="dashboard-controls">
          <!-- Selector de tiempo -->
          <p-selectButton 
            [options]="timeRangeOptions" 
            [(ngModel)]="selectedTimeRange"
            (onChange)="onTimeRangeChange()"
            styleClass="time-selector">
          </p-selectButton>

          <!-- Bot√≥n de refresh -->
          <p-button 
            icon="pi pi-refresh" 
            label="Actualizar"
            [loading]="loading.dashboard"
            (onClick)="refreshDashboard()"
            styleClass="ml-2">
          </p-button>
        </div>
      </ng-template>
    </p-toolbar>
  </div>

  <!-- Loading State -->
  @if (loading.dashboard && !dashboardData) {
  <div class="dashboard-loading">
    <p-card>
      <div class="text-center py-6">
        <i class="pi pi-spin pi-spinner text-4xl text-primary mb-4"></i>
        <h3>Cargando m√©tricas del dashboard...</h3>
        <p class="text-muted">Esto puede tomar unos segundos</p>
      </div>
    </p-card>
  </div>
  }

  <!-- Error State -->
  @if (hasError && !dashboardData) {
  <div class="dashboard-error">
    <p-message severity="error" [closable]="false">
      <div class="flex align-items-center">
        <i class="pi pi-exclamation-triangle text-2xl mr-3"></i>
        <div>
          <h4 class="m-0 mb-2">Error al cargar el dashboard</h4>
          <p class="m-0">{{ errors.dashboard || 'Error desconocido' }}</p>
          <p-button 
            label="Reintentar" 
            icon="pi pi-refresh"
            size="small"
            (onClick)="refreshDashboard()"
            styleClass="mt-2">
          </p-button>
        </div>
      </div>
    </p-message>
  </div>
  }

  <!-- Dashboard Content -->
  @if (dashboardData) {

  <!-- SECCI√ìN 1: WIDGETS DE M√âTRICAS PRINCIPALES -->
  <div class="metrics-overview-section mb-4">
    <h3 class="section-title mb-3">
      <i class="pi pi-bolt text-primary"></i>
      Resumen Ejecutivo
    </h3>

    <div class="grid">
      
      <!-- Widget de Moderaci√≥n (Cr√≠tico) -->
      <div class="col-12 md:col-6 lg:col-3">
        <p-card styleClass="dashboard-card priority-card">
          <ng-template pTemplate="header">
            <div class="card-header-custom" [ngClass]="getModerationSeverity()">
              <i class="pi pi-shield text-2xl"></i>
              <span class="header-title">Moderaci√≥n</span>
            </div>
          </ng-template>

          <div class="metric-content">
            <div class="primary-metric-large">
              {{ dashboardData.moderation.pendingReports }}
              <small>Reportes Pendientes</small>
            </div>

            <p-divider></p-divider>

            <div class="flex justify-content-between">
              <div class="metric-small">
                <span class="metric-value">{{ dashboardData.today.newReports }}</span>
                <small>Nuevos hoy</small>
              </div>
              <div class="metric-small">
                <span class="metric-value">{{ moderationEfficiency }}%</span>
                <small>Eficiencia</small>
              </div>
            </div>
          </div>

          <ng-template pTemplate="footer">
            @if (dashboardData.moderation.pendingReports > 0) {
            <p-button 
              label="Ver Reportes" 
              icon="pi pi-arrow-right"
              size="small"
              severity="warn"
              (onClick)="navigateToReports()"
              styleClass="w-full">
            </p-button>
            } @else {
            <p-tag value="Todo al d√≠a" severity="success" styleClass="w-full justify-content-center"></p-tag>
            }
          </ng-template>
        </p-card>
      </div>

      <!-- Widget de Usuarios -->
      <div class="col-12 md:col-6 lg:col-3">
        <p-card styleClass="dashboard-card users-card">
          <ng-template pTemplate="header">
            <div class="card-header-custom info">
              <i class="pi pi-users text-2xl"></i>
              <span class="header-title">Usuarios</span>
            </div>
          </ng-template>

          <div class="metric-content">
            <div class="primary-metric-large">
              {{ formatNumber(dashboardData.overview.totalUsers) }}
              <small>Total Registrados</small>
            </div>

            <p-divider></p-divider>

            <div class="flex justify-content-between mb-2">
              <div class="metric-small">
                <span class="metric-value text-green-500">+{{ dashboardData.today.newUsers }}</span>
                <small>Nuevos hoy</small>
              </div>
              <div class="metric-small">
                <span class="metric-value text-purple-500">{{ dashboardData.overview.premiumUsers }}</span>
                <small>Premium</small>
              </div>
            </div>

            <div class="trend-indicator">
              <p-tag 
                [value]="formatPercentage(userGrowthPercentage)" 
                [severity]="userGrowthPercentage > 0 ? 'success' : 'danger'"
                styleClass="trend-tag">
              </p-tag>
              <small class="ml-2">vs. promedio {{ selectedTimeRange === 'today' ? 'por hora' : 'diario' }}</small>
            </div>
          </div>
        </p-card>
      </div>

      <!-- Widget de Actividad -->
      <div class="col-12 md:col-6 lg:col-3">
        <p-card styleClass="dashboard-card activity-card">
          <ng-template pTemplate="header">
            <div class="card-header-custom" [ngClass]="getActivityLevel()">
              <i class="pi pi-chart-bar text-2xl"></i>
              <span class="header-title">Actividad</span>
            </div>
          </ng-template>

          <div class="metric-content">
            <div class="primary-metric-large">
              {{ formatNumber(dashboardData.today.newReviews + dashboardData.today.newComments) }}
              <small>Interacciones Hoy</small>
            </div>

            <p-divider></p-divider>

            <div class="flex justify-content-between mb-2">
              <div class="metric-small">
                <span class="metric-value">{{ dashboardData.today.newReviews }}</span>
                <small>Rese√±as</small>
              </div>
              <div class="metric-small">
                <span class="metric-value">{{ dashboardData.today.newComments }}</span>
                <small>Comentarios</small>
              </div>
            </div>

            <div class="trend-indicator">
              <p-tag 
                [value]="formatPercentage(activityGrowthPercentage)" 
                [severity]="activityGrowthPercentage > 0 ? 'success' : 'warn'"
                styleClass="trend-tag">
              </p-tag>
              <small class="ml-2">vs. promedio semanal</small>
            </div>
          </div>
        </p-card>
      </div>

      <!-- Widget de Engagement -->
      <div class="col-12 md:col-6 lg:col-3">
        <p-card styleClass="dashboard-card engagement-card">
          <ng-template pTemplate="header">
            <div class="card-header-custom warning">
              <i class="pi pi-heart text-2xl"></i>
              <span class="header-title">Engagement</span>
            </div>
          </ng-template>

          <div class="metric-content">
            <div class="primary-metric-large">
              {{ formatNumber(dashboardData.today.totalLikes) }}
              <small>Likes Hoy</small>
            </div>

            <p-divider></p-divider>

            <div class="flex justify-content-between mb-2">
              <div class="metric-small">
                <span class="metric-value">{{ dashboardData.content.averageRating.toFixed(1) }}/10</span>
                <small>Rating Promedio</small>
              </div>
              <div class="metric-small">
                <span class="metric-value">{{ realtimeMetrics?.activeUsersNow || 0 }}</span>
                <small>Activos ahora</small>
              </div>
            </div>

            <div class="progress-indicator">
              <small class="block mb-1">Calidad del contenido</small>
              <p-progressBar 
                [value]="(dashboardData.content.averageRating / 10) * 100"
                [showValue]="false"
                styleClass="rating-progress">
              </p-progressBar>
            </div>
          </div>
        </p-card>
      </div>

    </div>
  </div>

  <!-- SECCI√ìN 2: GR√ÅFICAS PRINCIPALES -->
  @if (canShowCharts) {
  <div class="charts-section mb-4">
    <h3 class="section-title mb-3">
      <i class="pi pi-chart-line text-primary"></i>
      Tendencias y An√°lisis
    </h3>

    <div class="grid">
      
      <!-- Gr√°fica de Crecimiento de Usuarios -->
      <div class="col-12 xl:col-6">
        <p-card styleClass="chart-card">
          <ng-template pTemplate="header">
            <div class="chart-header">
              <h4 class="chart-title">
                <i class="pi pi-arrow-up-right mr-2"></i>
                Crecimiento de Usuarios
              </h4>
              @if (loading.charts) {
              <p-progressBar mode="indeterminate" styleClass="chart-loading"></p-progressBar>
              }
            </div>
          </ng-template>

          @if (userGrowthChartData && !loading.charts) {
          <p-chart 
            type="line" 
            [data]="userGrowthChartData" 
            [options]="userGrowthChartOptions"
            height="300px">
          </p-chart>
          } @else {
          <div class="chart-placeholder">
            <p-skeleton height="300px"></p-skeleton>
          </div>
          }
        </p-card>
      </div>

      <!-- Gr√°fica de Actividad -->
      <div class="col-12 xl:col-6">
        <p-card styleClass="chart-card">
          <ng-template pTemplate="header">
            <div class="chart-header">
              <h4 class="chart-title">
                <i class="pi pi-chart-bar mr-2"></i>
                Tendencias de Actividad
              </h4>
            </div>
          </ng-template>

          @if (activityTrendsChartData && !loading.charts) {
          <p-chart 
            type="bar" 
            [data]="activityTrendsChartData" 
            [options]="activityTrendsChartOptions"
            height="300px">
          </p-chart>
          } @else {
          <div class="chart-placeholder">
            <p-skeleton height="300px"></p-skeleton>
          </div>
          }
        </p-card>
      </div>

    </div>
  </div>
  }

  <!-- SECCI√ìN 3: ESTAD√çSTICAS DETALLADAS -->
  <div class="detailed-stats-section mb-4">
    <h3 class="section-title mb-3">
      <i class="pi pi-table text-primary"></i>
      Estad√≠sticas Detalladas
    </h3>

    <div class="grid">
      
      <!-- Panel de Estad√≠sticas de Contenido -->
      <div class="col-12 lg:col-8">
        <p-card styleClass="stats-card">
          <ng-template pTemplate="header">
            <h4 class="card-title">
              <i class="pi pi-file-text mr-2"></i>
              Estad√≠sticas de Contenido
            </h4>
          </ng-template>

          <div class="grid stats-grid">
            <div class="col-6 md:col-3">
              <div class="stat-item">
                <div class="stat-number text-blue-500">{{ formatNumber(dashboardData.overview.totalReviews) }}</div>
                <div class="stat-label">Total Rese√±as</div>
              </div>
            </div>
            <div class="col-6 md:col-3">
              <div class="stat-item">
                <div class="stat-number text-green-500">{{ formatNumber(dashboardData.overview.totalComments) }}</div>
                <div class="stat-label">Total Comentarios</div>
              </div>
            </div>
            <div class="col-6 md:col-3">
              <div class="stat-item">
                <div class="stat-number text-yellow-500">{{ formatNumber(dashboardData.overview.totalLists) }}</div>
                <div class="stat-label">Listas Creadas</div>
              </div>
            </div>
            <div class="col-6 md:col-3">
              <div class="stat-item">
                <div class="stat-number text-red-500">{{ formatNumber(dashboardData.content.totalLikes) }}</div>
                <div class="stat-label">Total Likes</div>
              </div>
            </div>
          </div>

          <p-divider></p-divider>

          <!-- Usuario m√°s activo -->
          @if (mostActiveUser) {
          <div class="highlight-section">
            <div class="flex align-items-center justify-content-between">
              <div>
                <h5 class="m-0 mb-1">
                  <i class="pi pi-star-fill text-yellow-500 mr-2"></i>
                  Usuario M√°s Activo
                </h5>
                <p class="m-0 text-lg font-bold">{{ mostActiveUser.username }}</p>
              </div>
              <div class="text-right">
                <p-tag 
                  [value]="mostActiveUser.activityScore + ' puntos'"
                  severity="info"
                  styleClass="activity-score-tag">
                </p-tag>
              </div>
            </div>
          </div>
          }
        </p-card>
      </div>

      <!-- Gr√°fica de Distribuci√≥n -->
      <div class="col-12 lg:col-4">
        <p-card styleClass="chart-card pie-chart-card">
          <ng-template pTemplate="header">
            <h4 class="card-title">
              <i class="pi pi-chart-pie mr-2"></i>
              Distribuci√≥n
            </h4>
          </ng-template>

          @if (contentDistributionChartData && !loading.charts) {
          <p-chart 
            type="doughnut" 
            [data]="contentDistributionChartData" 
            [options]="contentDistributionChartOptions"
            height="250px">
          </p-chart>
          } @else {
          <div class="chart-placeholder">
            <p-skeleton height="250px" shape="circle"></p-skeleton>
          </div>
          }
        </p-card>
      </div>

    </div>
  </div>

  <!-- SECCI√ìN 4: PEL√çCULAS POPULARES -->
 @if (topMovies.length > 0) {
<div class="popular-content-section mb-4">
  <h3 class="section-title mb-3">
    <i class="pi pi-trophy text-primary"></i>
    Contenido M√°s Popular
  </h3>

  <p-card styleClass="popular-movies-card">
    <div class="grid">
      @for (movie of topMovies; track movie.movieId) {
      <div class="col-12 md:col-6 lg:col-4 xl:col-2-4">
        <div class="movie-rank-card">
          
          <!-- Badge de ranking -->
          <div class="movie-rank-badge">
            <p-tag [value]="'#' + ($index + 1)" severity="warn"></p-tag>
          </div>
          
          <!-- Poster de la pel√≠cula -->
          <div class="movie-poster-container">
            @if (getMoviePoster(movie.movieId)) {
            <img 
              [src]="getMoviePoster(movie.movieId)" 
              [alt]="movie.title || 'Pel√≠cula ' + movie.movieId"
              class="movie-poster"
              (error)="onPosterError($event, movie.movieId)"
              loading="lazy">
            <div class="movie-poster-overlay"></div>
            } @else {
            <div class="movie-poster-placeholder">
              <i class="pi pi-image"></i>
            </div>
            }
          </div>
          
          <!-- Informaci√≥n de la pel√≠cula -->
          <div class="movie-info">
            <h5 class="movie-title">
              @if (movie.title) {
              {{ movie.title }}
              } @else {
              Pel√≠cula ID: {{ movie.movieId }}
              }
            </h5>
            
            <div class="movie-stats">
              <!-- Estad√≠stica de rese√±as -->
              <div class="stat-badge">
                <div class="flex align-items-center">
                  <i class="pi pi-comment"></i>
                  <span>Rese√±as</span>
                </div>
                <span>{{ formatNumber(movie.reviewCount) }}</span>
              </div>
              
              <!-- Estad√≠stica de rating -->
              <div class="stat-badge">
                <div class="flex align-items-center">
                  <i class="pi pi-star-fill"></i>
                  <span>Rating</span>
                </div>
                <span>{{ movie.averageRating.toFixed(1) }}/10</span>
              </div>
              
              <!-- Estad√≠stica adicional: engagement -->
              @if (movie.totalLikes) {
              <div class="stat-badge">
                <div class="flex align-items-center">
                  <i class="pi pi-heart-fill"></i>
                  <span>Likes</span>
                </div>
                <span>{{ formatNumber(movie.totalLikes) }}</span>
              </div>
              }
              
              <!-- Estad√≠stica adicional: tendencia -->
              @if (movie.trendingScore) {
              <div class="stat-badge">
                <div class="flex align-items-center">
                  <i class="pi pi-arrow-up"></i>
                  <span>Tendencia</span>
                </div>
                <span>+{{ movie.trendingScore }}%</span>
              </div>
              }
              
              <!-- Bot√≥n para ver m√°s detalles -->
              <p-button 
                label="Ver Detalles" 
                icon="pi pi-external-link"
                size="small"
                severity="secondary"
                styleClass="w-full mt-2"
                (onClick)="viewMovieDetails(movie.movieId)"
                pTooltip="Ver detalles completos de la pel√≠cula">
              </p-button>
            </div>
          </div>
        </div>
      </div>
      }
    </div>
    
    <!-- Footer con estad√≠sticas generales -->
    <ng-template pTemplate="footer">
      <div class="flex justify-content-between align-items-center">
        <div class="text-sm text-muted">
          <i class="pi pi-info-circle mr-2"></i>
          Top {{ topMovies.length }} pel√≠culas m√°s populares del {{ selectedTimeRange === 'today' ? 'd√≠a' : selectedTimeRange === 'week' ? '√∫ltima semana' : '√∫ltimo mes' }}
        </div>
        <div class="flex gap-2">
          <p-button 
            label="Ver Todas" 
            icon="pi pi-arrow-right"
            size="small"
            severity="secondary"
            (onClick)="viewAllPopularMovies()">
          </p-button>
          <p-button 
            label="Exportar" 
            icon="pi pi-download"
            size="small"
            severity="secondary"
            (onClick)="exportPopularMovies()">
          </p-button>
        </div>
      </div>
    </ng-template>
  </p-card>
</div>
}

  <!-- SECCI√ìN 5: MODERACI√ìN Y ALERTAS -->
  <div class="moderation-alerts-section mb-4">
    <h3 class="section-title mb-3">
      <i class="pi pi-shield text-primary"></i>
      Estado del Sistema y Alertas
    </h3>

    <div class="grid">
      
      <!-- Panel de Moderaci√≥n -->
      <div class="col-12 lg:col-8">
        <p-card styleClass="moderation-card">
          <ng-template pTemplate="header">
            <h4 class="card-title">
              <i class="pi pi-shield mr-2"></i>
              M√©tricas de Moderaci√≥n
            </h4>
          </ng-template>

          <div class="grid moderation-metrics">
            <div class="col-6 md:col-3">
              <div class="moderation-metric-item pending">
                <div class="metric-icon">
                  <i class="pi pi-clock"></i>
                </div>
                <div class="metric-data">
                  <span class="metric-number">{{ dashboardData.moderation.pendingReports }}</span>
                  <span class="metric-label">Pendientes</span>
                </div>
              </div>
            </div>
            
            <div class="col-6 md:col-3">
              <div class="moderation-metric-item resolved">
                <div class="metric-icon">
                  <i class="pi pi-check-circle"></i>
                </div>
                <div class="metric-data">
                  <span class="metric-number">{{ dashboardData.period.newReports - dashboardData.moderation.pendingReports }}</span>
                  <span class="metric-label">Resueltos</span>
                </div>
              </div>
            </div>
            
            <div class="col-6 md:col-3">
              <div class="moderation-metric-item time">
                <div class="metric-icon">
                  <i class="pi pi-stopwatch"></i>
                </div>
                <div class="metric-data">
                  <span class="metric-number">{{ formatTime(dashboardData.moderation.averageResolutionTime) }}</span>
                  <span class="metric-label">Tiempo Promedio</span>
                </div>
              </div>
            </div>
            
            <div class="col-6 md:col-3">
              <div class="moderation-metric-item bans">
                <div class="metric-icon">
                  <i class="pi pi-ban"></i>
                </div>
                <div class="metric-data">
                  <span class="metric-number">{{ dashboardData.today.newBans }}</span>
                  <span class="metric-label">Bans Hoy</span>
                </div>
              </div>
            </div>
          </div>

          <p-divider></p-divider>

          <div class="moderation-summary">
            <div class="flex align-items-center justify-content-between">
              <div>
                <h5 class="m-0 mb-1">Eficiencia de Moderaci√≥n</h5>
                <p class="m-0 text-sm text-muted">
                  Tipo m√°s com√∫n: <strong>{{ getReasonDisplayText(dashboardData.moderation.mostCommonReportType) }}</strong>
                </p>
              </div>
              <div class="text-right">
                <p-progressBar 
                  [value]="moderationEfficiency" 
                  [showValue]="true"
                  styleClass="efficiency-progress">
                </p-progressBar>
              </div>
            </div>
          </div>

          <ng-template pTemplate="footer">
            <div class="flex gap-2">
              <p-button 
                label="Ver Reportes" 
                icon="pi pi-external-link"
                size="small"
                (onClick)="navigateToReports()">
              </p-button>
              <p-button 
                label="Gestionar Usuarios" 
                icon="pi pi-users"
                size="small"
                severity="secondary"
                (onClick)="navigateToUsers()">
              </p-button>
            </div>
          </ng-template>
        </p-card>
      </div>

      <!-- Panel de Alertas del Sistema -->
      <div class="col-12 lg:col-4">
        <p-card styleClass="alerts-card">
          <ng-template pTemplate="header">
            <h4 class="card-title">
              <i class="pi pi-bell mr-2"></i>
              Alertas del Sistema
            </h4>
          </ng-template>

          <div class="alerts-list">
            
            <!-- Alerta de reportes pendientes -->
            @if (dashboardData.moderation.pendingReports > 10) {
            <p-message severity="warn" [closable]="false" styleClass="mb-3">
              <div>
                <strong>Alto volumen de reportes</strong>
                <p class="m-0 mt-1 text-sm">
                  {{ dashboardData.moderation.pendingReports }} reportes esperando revisi√≥n
                </p>
                <p-button 
                  label="Revisar" 
                  size="small"
                  severity="warn"
                  (onClick)="navigateToReports()"
                  styleClass="mt-2">
                </p-button>
              </div>
            </p-message>
            }

            <!-- Alerta de actividad de moderaci√≥n elevada -->
            @if (dashboardData.today.newBans > 5) {
            <p-message severity="info" [closable]="false" styleClass="mb-3">
              <div>
                <strong>Actividad de moderaci√≥n elevada</strong>
                <p class="m-0 mt-1 text-sm">
                  {{ dashboardData.today.newBans }} usuarios baneados hoy
                </p>
              </div>
            </p-message>
            }

            <!-- Alerta de crecimiento excepcional -->
            @if (userGrowthPercentage > 50) {
            <p-message severity="success" [closable]="false" styleClass="mb-3">
              <div>
                <strong>üéâ Crecimiento excepcional</strong>
                <p class="m-0 mt-1 text-sm">
                  {{ userGrowthPercentage }}% por encima del promedio
                </p>
              </div>
            </p-message>
            }

            <!-- Estado de salud del sistema -->
            @if (realtimeMetrics?.systemHealth) {
            <div class="system-health-indicator">
              <div class="flex align-items-center justify-content-between mb-2">
                <span class="font-medium">Estado del Sistema</span>
                <p-tag 
                  [value]="systemHealth" 
                  [severity]="systemHealth === 'excellent' ? 'success' : systemHealth === 'warn' ? 'warn' : 'danger'">
                </p-tag>
              </div>
              <div class="health-metrics text-sm">
                <div class="flex justify-content-between">
                  <span>Conexiones activas:</span>
                  {{ realtimeMetrics?.systemHealth?.activeConnections || 0 }}
                </div>
                <div class="flex justify-content-between">
                  <span>Tiempo de respuesta:</span>
                 {{ realtimeMetrics?.systemHealth?.responseTime || 0 }}ms
                </div>
              </div>
            </div>
            }

            <!-- Sin alertas cr√≠ticas -->
            @if (
              dashboardData.moderation.pendingReports <= 10 &&
              dashboardData.today.newBans <= 5 &&
              userGrowthPercentage <= 50
            ) {
            <p-message severity="success" [closable]="false">
              <div>
                <strong>‚úÖ Sistema funcionando correctamente</strong>
                <p class="m-0 mt-1 text-sm">
                  No hay alertas cr√≠ticas en este momento
                </p>
              </div>
            </p-message>
            }

          </div>
        </p-card>
      </div>

    </div>
  </div>

  <!-- SECCI√ìN 6: ACCIONES R√ÅPIDAS -->
  <div class="quick-actions-section">
    <h3 class="section-title mb-3">
      <i class="pi pi-bolt text-primary"></i>
      Acciones R√°pidas
    </h3>

    <div class="grid">
      
      <div class="col-12 md:col-6 lg:col-3">
        <p-card styleClass="quick-action-card reports-action" 
                (click)="navigateToReports()">
          <div class="action-content">
            <div class="action-icon">
              <i class="pi pi-flag text-3xl"></i>
              @if (dashboardData.moderation.pendingReports > 0) {
              <p-badge 
                [value]="dashboardData.moderation.pendingReports" 
                severity="danger"
                styleClass="notification-badge">
              </p-badge>
              }
            </div>
            <div class="action-info">
              <h5 class="action-title">Revisar Reportes</h5>
              <p class="action-description">Gestionar reportes pendientes</p>
            </div>
          </div>
        </p-card>
      </div>

      <div class="col-12 md:col-6 lg:col-3">
        <p-card styleClass="quick-action-card users-action" 
                (click)="navigateToUsers()">
          <div class="action-content">
            <div class="action-icon">
              <i class="pi pi-users text-3xl"></i>
            </div>
            <div class="action-info">
              <h5 class="action-title">Gestionar Usuarios</h5>
              <p class="action-description">Administrar cuentas de usuario</p>
            </div>
          </div>
        </p-card>
      </div>

      <div class="col-12 md:col-6 lg:col-3">
        <p-card styleClass="quick-action-card content-action" 
                (click)="navigateToContent()">
          <div class="action-content">
            <div class="action-icon">
              <i class="pi pi-file-text text-3xl"></i>
            </div>
            <div class="action-info">
              <h5 class="action-title">Moderar Contenido</h5>
              <p class="action-description">Revisar rese√±as y comentarios</p>
            </div>
          </div>
        </p-card>
      </div>

      <div class="col-12 md:col-6 lg:col-3">
        <p-card styleClass="quick-action-card refresh-action" 
                (click)="refreshDashboard()">
          <div class="action-content">
            <div class="action-icon">
              <i class="pi pi-refresh text-3xl"></i>
            </div>
            <div class="action-info">
              <h5 class="action-title">Actualizar Datos</h5>
              <p class="action-description">Refrescar todas las m√©tricas</p>
            </div>
          </div>
        </p-card>
      </div>

    </div>
  </div>

  } <!-- Fin del @if (dashboardData) -->

  <!-- FALLBACK: Estad√≠sticas b√°sicas si no hay datos avanzados -->
  @if (!dashboardData && stats && !loading.dashboard) {
  <div class="basic-stats-fallback">
    <p-card>
      <ng-template pTemplate="header">
        <h3>Estad√≠sticas B√°sicas del Sistema</h3>
      </ng-template>

      <div class="grid">
        <div class="col-12 md:col-6 lg:col-4 xl:col-2">
          <div class="basic-stat-item">
            <div class="stat-number">{{ stats.overview.totalUsers }}</div>
            <div class="stat-label">Total Usuarios</div>
          </div>
        </div>

        <div class="col-12 md:col-6 lg:col-4 xl:col-2">
          <div class="basic-stat-item">
            <div class="stat-number">{{ stats.overview.activeUsers }}</div>
            <div class="stat-label">Usuarios Activos</div>
          </div>
        </div>

        <div class="col-12 md:col-6 lg:col-4 xl:col-2">
          <div class="basic-stat-item">
            <div class="stat-number">{{ stats.overview.bannedUsers }}</div>
            <div class="stat-label">Usuarios Baneados</div>
          </div>
        </div>

        <div class="col-12 md:col-6 lg:col-4 xl:col-2">
          <div class="basic-stat-item">
            <div class="stat-number">{{ stats.overview.totalReviews }}</div>
            <div class="stat-label">Total Rese√±as</div>
          </div>
        </div>

        <div class="col-12 md:col-6 lg:col-4 xl:col-2">
          <div class="basic-stat-item">
            <div class="stat-number">{{ stats.overview.totalComments }}</div>
            <div class="stat-label">Total Comentarios</div>
          </div>
        </div>

        <div class="col-12 md:col-6 lg:col-4 xl:col-2">
          <div class="basic-stat-item">
            <div class="stat-number">{{ stats.overview.totalLists }}</div>
            <div class="stat-label">Total Listas</div>
          </div>
        </div>
      </div>

      <p-divider></p-divider>

      <!-- Actividad de hoy -->
      <h4>Actividad de Hoy</h4>
      <div class="grid">
        <div class="col-12 md:col-6 lg:col-3">
          <div class="basic-stat-item today">
            <div class="stat-number">{{ stats.today.newUsers }}</div>
            <div class="stat-label">Nuevos Usuarios</div>
          </div>
        </div>

        <div class="col-12 md:col-6 lg:col-3">
          <div class="basic-stat-item today">
            <div class="stat-number">{{ stats.today.newReviews }}</div>
            <div class="stat-label">Nuevas Rese√±as</div>
          </div>
        </div>

        <div class="col-12 md:col-6 lg:col-3">
          <div class="basic-stat-item today">
            <div class="stat-number">{{ stats.today.newComments }}</div>
            <div class="stat-label">Nuevos Comentarios</div>
          </div>
        </div>

        <div class="col-12 md:col-6 lg:col-3">
          <div class="basic-stat-item today">
            <div class="stat-number">{{ stats.today.newLists }}</div>
            <div class="stat-label">Nuevas Listas</div>
          </div>
        </div>
      </div>

      <ng-template pTemplate="footer">
        <p-message severity="info" [closable]="false">
          <div>
            <strong>üìä Dashboard Mejorado Disponible</strong>
            <p class="m-0 mt-1">
              Actualiza el backend para acceder a m√©tricas avanzadas, gr√°ficas interactivas y alertas en tiempo real.
            </p>
          </div>
        </p-message>
      </ng-template>
    </p-card>
  </div>
  }

</div>

<!-- FIN del contenido del Dashboard Tab -->

    <!-- Users Tab -->
    <div class="tab-content" [class.active]="tabState.activeTab === 'users'" *ngIf="canManageUsers">
      <div class="admin-card">
        <h3>Gesti√≥n de Usuarios</h3>

        <!-- Formulario de B√∫squeda Global -->
        <form [formGroup]="userSearchForm" class="search-filters">
          <input type="text" class="search-input" placeholder="Buscar por username o email..." formControlName="search">

          <select class="filter-select" formControlName="role">
            <option value="">Todos los roles</option>
            <option value="admin">Administrador</option>
            <option value="moderator">Moderador</option>
            <option value="premium">Premium</option>
            <option value="user">Usuario</option>
          </select>

          <select class="filter-select" formControlName="status">
            <option value="">Todos los estados</option>
            <option value="active">Activos</option>
            <option value="banned">Baneados</option>
          </select>

          <button type="button" class="search-btn" (click)="searchGlobally()">
            Buscar
          </button>
        </form>

        @if (loading.users && users.length === 0) {
        <div class="loading">
          <div class="loading-spinner"></div>
          <span>Cargando usuarios...</span>
        </div>
        }

        @if (errors.users) {
        <div class="error-message">
          {{ errors.users }}
        </div>
        }

        @if (users.length > 0) {
        <div class="table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Usuario</th>
                <th>Email</th>
                <th>Rol</th>
                <th>Estado</th>
                <th>Registro</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              @for (user of users; track user._id) {
              <tr>
                <td>
                  <div class="flex-center">
                    <img [src]="getUserAvatarPath(user.avatar || 'avatar1')" alt="Avatar" class="user-avatar">
                    <div>
                      <div style="font-weight: 600; color: var(--text-primary);">{{ user.username }}</div>
                      @if (user.biografia) {
                      <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px; line-height: 1.2;">
                        {{ user.biografia.length > 40 ? (user.biografia | slice:0:40) + '...' : user.biografia }}
                      </div>
                      }
                    </div>
                  </div>
                </td>
                <td>
                  <div style="color: var(--text-primary);">{{ user.email }}</div>
                  <!-- @if (user.isPremium) {
                  <div style="margin-top: 4px;">
                    <span class="badge-premium">Premium</span>
                  </div>
                  } -->
                </td>
                <td>
                  <span class="status-badge" [ngClass]="getRoleClass(user.role)">
                    {{ user.role }}
                  </span>
                </td>
                <td>
                  @if (user.isBanned) {
                  <div>
                    <span class="status-badge status-banned">Baneado</span>
                    @if (user.banExpiresAt) {
                    <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 2px; line-height: 1.2;">
                      Expira: {{ formatDate(user.banExpiresAt) }}
                    </div>
                    }
                    @if (user.banReason) {
                    <div style="font-size: 0.7rem; color: var(--color-error); margin-top: 2px; line-height: 1.2;"
                      [title]="user.banReason">
                      {{ user.banReason.length > 25 ? (user.banReason | slice:0:25) + '...' : user.banReason }}
                    </div>
                    }
                  </div>
                  } @else {
                  <span class="status-badge status-active">Activo</span>
                  }
                </td>
                <td>
                  <div style="color: var(--text-primary);">{{ formatDate(user.createdAt) }}</div>
                  @if (user.moderationHistory && user.moderationHistory.length > 0) {
                  <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 2px;">
                    {{ user.moderationHistory.length }} acciones
                  </div>
                  }
                </td>
                <td>
                  <div class="actions-container">
                    @if (!user.isBanned && canBanUsers) {
                    <button class="action-btn btn-warning" (click)="openBanModal(user)"
                      [title]="'Banear a ' + user.username">
                      Ban
                    </button>
                    }

                    @if (user.isBanned && canBanUsers) {
                    <button class="action-btn btn-success" (click)="unbanUser(user)"
                      [title]="'Desbanear a ' + user.username">
                      Unban
                    </button>
                    }

                    @if (isAdmin) {
                    <button class="action-btn btn-primary" (click)="openRoleModal(user)"
                      [title]="'Cambiar rol de ' + user.username">
                      Rol
                    </button>
                    }

                    @if (user.moderationHistory && user.moderationHistory.length > 0) {
                    <button class="action-btn btn-secondary" (click)="openHistoryModal(user)"
                      [title]="'Ver historial de ' + user.username">
                      Historial
                    </button>
                    }
                  </div>
                </td>
              </tr>
              }
            </tbody>
          </table>
        </div>

        @if (pagination.users.hasMore) {
        <div class="pagination">
          <button class="load-more-btn" [disabled]="loading.users" (click)="loadMoreUsers()">
            @if (loading.users) {
            Cargando...
            } @else {
            Cargar m√°s usuarios
            }
          </button>
        </div>
        }
        } @else if (!loading.users) {
        <div class="empty-state">
          <div class="empty-state-icon">üë•</div>
          <p>No se encontraron usuarios con los filtros aplicados</p>
        </div>
        }
      </div>
    </div>

    <!-- Content Tab - Moderaci√≥n de Contenido -->
    <div class="tab-content" [class.active]="tabState.activeTab === 'content'" *ngIf="canModerateContent">
      <div class="admin-card">
        <h3>Moderaci√≥n de Contenido</h3>

        <!-- Formulario de B√∫squeda Espec√≠fico para Contenido -->
        <form [formGroup]="contentSearchForm" class="search-filters">
          <input type="text" class="search-input" placeholder="Buscar por username del autor..."
            formControlName="username">

          <select class="filter-select" formControlName="userRole">
            <option value="">Todos los roles</option>
            <option value="admin">Administrador</option>
            <option value="moderator">Moderador</option>
            <option value="premium">Premium</option>
            <option value="user">Usuario</option>
          </select>

          <button type="button" class="search-btn" (click)="searchContent()">
            Buscar Contenido
          </button>

          <button type="button" class="action-btn btn-secondary" (click)="clearContentSearch()"
            style="height: 44px; min-width: 80px;">
            Limpiar
          </button>
        </form>

        <!-- Sub-navegaci√≥n de contenido -->
        <div class="content-tabs">
          <button class="content-tab" [class.active]="tabState.activeContentTab === 'reviews'"
            (click)="showContentTab('reviews')">
            Rese√±as
            @if (isContentFiltered && filteredReviews.length > 0) {
            <span
              style="background: var(--color-primary); color: white; border-radius: 12px; padding: 2px 8px; font-size: 0.7rem; margin-left: 4px;">
              {{ filteredReviews.length }}
            </span>
            }
          </button>

          <button class="content-tab" [class.active]="tabState.activeContentTab === 'comments'"
            (click)="showContentTab('comments')">
            Comentarios
            @if (isContentFiltered && filteredComments.length > 0) {
            <span
              style="background: var(--color-primary); color: white; border-radius: 12px; padding: 2px 8px; font-size: 0.7rem; margin-left: 4px;">
              {{ filteredComments.length }}
            </span>
            }
          </button>

          <button class="content-tab" [class.active]="tabState.activeContentTab === 'lists'"
            (click)="showContentTab('lists')">
            Listas
            @if (isContentFiltered && filteredLists.length > 0) {
            <span
              style="background: var(--color-primary); color: white; border-radius: 12px; padding: 2px 8px; font-size: 0.7rem; margin-left: 4px;">
              {{ filteredLists.length }}
            </span>
            }
          </button>
        </div>

        <!-- Rese√±as -->
        <div class="tab-content" [class.active]="tabState.activeContentTab === 'reviews'">
          @if (loading.reviews && reviews.length === 0) {
          <div class="loading">
            <div class="loading-spinner"></div>
            <span>Cargando rese√±as...</span>
          </div>
          }

          @if (errors.reviews) {
          <div class="error-message">
            {{ errors.reviews }}
          </div>
          }

          @if (displayReviews.length > 0) {
          <div class="table-container">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Usuario</th>
                  <th>Pel√≠cula</th>
                  <th>Puntuaci√≥n</th>
                  <th>Comentario</th>
                  <th>Fecha</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                @for (review of displayReviews; track review._id) {
                <tr>
                  <td>
                    <div class="flex-center">
                      <img [src]="getUserAvatarPath(review.userId.avatar)" alt="Avatar" class="user-avatar">
                      <div>
                        <div style="font-weight: 600; color: var(--text-primary);">{{ review.userId.username }}</div>
                        <span class="status-badge" [ngClass]="getRoleClass(review.userId.role)"
                          style="font-size: 0.65rem; margin-top: 2px;">
                          {{ review.userId.role }}
                        </span>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div style="font-weight: 600; color: var(--text-primary);">ID: {{ review.movieId }}</div>
                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px;">
                      {{ formatDate(review.createdAt) }}
                    </div>
                  </td>
                  <td>
                    <div style="display: flex; align-items: center; gap: 4px;">
                      <span style="color: var(--color-warning); font-weight: 600; font-size: 1rem;">
                        {{ review.rating }}/10
                      </span>
                    </div>
                  </td>
                  <td>
                    <div [title]="review.comment" style="max-width: 250px; line-height: 1.3;">
                      {{ review.comment.length > 80 ? (review.comment | slice:0:80) + '...' : review.comment }}
                    </div>
                    @if (review.comment.length > 80) {
                    <button class="action-btn btn-secondary" (click)="openReviewModal(review)"
                      style="margin-top: 4px; font-size: 0.65rem; padding: 2px 6px; height: 20px; min-width: 40px;">
                      Ver +
                    </button>
                    }
                  </td>
                  <td>
                    <div style="font-size: 0.8rem; color: var(--text-primary);">
                      {{ formatDate(review.createdAt) }}
                    </div>
                  </td>
                  <td>
                    <button class="action-btn btn-danger"
                      (click)="openDeleteModal('review', review._id, 'Rese√±a de ' + review.userId.username)">
                      Eliminar
                    </button>
                  </td>
                </tr>
                }
              </tbody>
            </table>
          </div>

          @if (pagination.reviews.hasMore) {
          <div class="pagination">
            <button class="load-more-btn" [disabled]="loading.reviews" (click)="loadMoreReviews()">
              @if (loading.reviews) {
              Cargando...
              } @else {
              Cargar m√°s rese√±as
              }
            </button>
          </div>
          }
          } @else if (!loading.reviews) {
          <div class="empty-state">
            <div class="empty-state-icon">üìù</div>
            <p>No se encontraron rese√±as para moderar</p>
          </div>
          }
        </div>

        <!-- Comentarios -->
        <div class="tab-content" [class.active]="tabState.activeContentTab === 'comments'">
          @if (loading.comments && comments.length === 0) {
          <div class="loading">
            <div class="loading-spinner"></div>
            <span>Cargando comentarios...</span>
          </div>
          }

          @if (errors.comments) {
          <div class="error-message">
            {{ errors.comments }}
          </div>
          }

          @if (displayComments.length > 0) {
          <div class="table-container">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Usuario</th>
                  <th>Comentario</th>
                  <th>Rese√±a</th>
                  <th>Fecha</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                @for (comment of displayComments; track comment._id) {
                <tr>
                  <td>
                    <div class="flex-center">
                      <img [src]="getUserAvatarPath(comment.userId.avatar)" alt="Avatar" class="user-avatar">
                      <div>
                        <div style="font-weight: 600; color: var(--text-primary);">{{ comment.userId.username }}</div>
                        <span class="status-badge" [ngClass]="getRoleClass(comment.userId.role)"
                          style="font-size: 0.65rem; margin-top: 2px;">
                          {{ comment.userId.role }}
                        </span>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div [title]="comment.text" style="max-width: 250px; line-height: 1.3;">
                      {{ comment.text.length > 80 ? (comment.text | slice:0:80) + '...' : comment.text }}
                    </div>
                    @if (comment.isEdited) {
                    <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 2px;">
                      Editado
                    </div>
                    }
                  </td>
                  <td>
                    <div style="font-size: 0.75rem; color: var(--text-secondary); word-break: break-all;">
                      @if (comment.reviewId && comment.reviewId._id) {
                      <div><strong>ID:</strong> {{ comment.reviewId._id }}</div>
                      @if (comment.reviewId.movieId) {
                      <div><strong>Pel√≠cula:</strong> {{ comment.reviewId.movieId }}</div>
                      }
                      @if (comment.reviewId.userId && comment.reviewId.userId.username) {
                      <div><strong>Autor:</strong> {{ comment.reviewId.userId.username }}</div>
                      }
                      } @else {
                      <div style="color: var(--color-warning);">Rese√±a no encontrada</div>
                      }
                    </div>
                  </td>
                  <td>
                    <div style="font-size: 0.8rem; color: var(--text-primary);">
                      {{ formatDate(comment.createdAt) }}
                    </div>
                  </td>
                  <td>
                    <button class="action-btn btn-danger"
                      (click)="openDeleteModal('comment', comment._id, 'Comentario de ' + comment.userId.username)">
                      Eliminar
                    </button>
                  </td>
                </tr>
                }
              </tbody>
            </table>
          </div>

          @if (pagination.comments.hasMore) {
          <div class="pagination">
            <button class="load-more-btn" [disabled]="loading.comments" (click)="loadMoreComments()">
              @if (loading.comments) {
              Cargando...
              } @else {
              Cargar m√°s comentarios
              }
            </button>
          </div>
          }
          } @else if (!loading.comments) {
          <div class="empty-state">
            <div class="empty-state-icon">üí¨</div>
            <p>No se encontraron comentarios para moderar</p>
          </div>
          }
        </div>

        <!-- Listas -->
        <div class="tab-content" [class.active]="tabState.activeContentTab === 'lists'">
          @if (loading.lists && lists.length === 0) {
          <div class="loading">
            <div class="loading-spinner"></div>
            <span>Cargando listas...</span>
          </div>
          }

          @if (errors.lists) {
          <div class="error-message">
            {{ errors.lists }}
          </div>
          }

          @if (displayLists.length > 0) {
          <div class="table-container">
            <table class="admin-table">
              <thead>
                <tr>
                  <th>Usuario</th>
                  <th>T√≠tulo</th>
                  <th>Descripci√≥n</th>
                  <th>Visibilidad</th>
                  <th>Pel√≠culas</th>
                  <th>Fecha</th>
                  <th>Acciones</th>
                </tr>
              </thead>
              <tbody>
                @for (list of displayLists; track list._id) {
                <tr>
                  <td>
                    <div class="flex-center">
                      <img [src]="getUserAvatarPath(list.userId.avatar)" alt="Avatar" class="user-avatar">
                      <div>
                        <div style="font-weight: 600; color: var(--text-primary);">{{ list.userId.username }}</div>
                        <span class="status-badge" [ngClass]="getRoleClass(list.userId.role)"
                          style="font-size: 0.65rem; margin-top: 2px;">
                          {{ list.userId.role }}
                        </span>
                      </div>
                    </div>
                  </td>
                  <td>
                    <div style="font-weight: 600; color: var(--text-primary); line-height: 1.3;">{{ list.title }}</div>
                    @if (list.coverImage) {
                    <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 2px;">
                      Con imagen
                    </div>
                    }
                  </td>
                  <td>
                    <div [title]="list.description" style="max-width: 200px; line-height: 1.3;">
                      {{ list.description && list.description.length > 40 ? (list.description | slice:0:40) + '...' :
                      list.description || 'Sin descripci√≥n' }}
                    </div>
                  </td>
                  <td>
                    @if (list.isPublic) {
                    <span class="status-badge status-active">
                      P√∫blica
                    </span>
                    } @else {
                    <span class="status-badge status-banned">
                      Privada
                    </span>
                    }
                  </td>
                  <td>
                    <div style="display: flex; align-items: center; gap: 4px; color: var(--text-primary);">
                      <span style="font-weight: 600;">{{ list.movies.length || 0 }}</span>
                      <span style="font-size: 0.8rem;">films</span>
                    </div>
                  </td>
                  <td>
                    <div style="font-size: 0.8rem; color: var(--text-primary);">
                      {{ formatDate(list.createdAt) }}
                    </div>
                  </td>
                  <td>
                    <button class="action-btn btn-danger" (click)="openDeleteModal('list', list._id, list.title)">
                      Eliminar
                    </button>
                  </td>
                </tr>
                }
              </tbody>
            </table>
          </div>

          @if (pagination.lists.hasMore) {
          <div class="pagination">
            <button class="load-more-btn" [disabled]="loading.lists" (click)="loadMoreLists()">
              @if (loading.lists) {
              Cargando...
              } @else {
              Cargar m√°s listas
              }
            </button>
          </div>
          }
          } @else if (!loading.lists) {
          <div class="empty-state">
            <div class="empty-state-icon">üìã</div>
            <p>No se encontraron listas para moderar</p>
          </div>
          }
        </div>
      </div>
    </div>

    <!-- Contenido de la pesta√±a Reports -->
    <div class="tab-content" [class.active]="tabState.activeTab === 'reports'" *ngIf="isModerator">
      <div class="admin-card">
        <h3>Sistema de Reportes</h3>

        <!-- Estad√≠sticas de reportes -->
        @if (reportStats) {
        <div class="reports-stats-grid">
          <div class="stat-card">
            <div class="stat-number">{{ reportStats.summary.total }}</div>
            <div class="stat-label">Total Reportes</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">{{ reportStats.summary.pending }}</div>
            <div class="stat-label">Pendientes</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">{{ reportStats.summary.underReview }}</div>
            <div class="stat-label">En Revisi√≥n</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">{{ reportStats.summary.resolved }}</div>
            <div class="stat-label">Resueltos</div>
          </div>
          <div class="stat-card">
            <div class="stat-number">{{ reportStats.summary.resolutionRate }}%</div>
            <div class="stat-label">Tasa de Resoluci√≥n</div>
          </div>
        </div>
        }

        <!-- Filtros de reportes -->
        <form [formGroup]="reportSearchForm" class="search-filters">
          <select class="filter-select" formControlName="status">
            <option value="">Todos los estados</option>
            <option value="pending">Pendientes</option>
            <option value="under_review">En revisi√≥n</option>
            <option value="resolved">Resueltos</option>
            <option value="dismissed">Descartados</option>
          </select>

          <select class="filter-select" formControlName="priority">
            <option value="">Todas las prioridades</option>
            <option value="urgent">Urgente</option>
            <option value="high">Alta</option>
            <option value="medium">Media</option>
            <option value="low">Baja</option>
          </select>

          <select class="filter-select" formControlName="contentType">
            <option value="">Todos los tipos</option>
            <option value="user">Perfil de usuario</option>
            <option value="review">Rese√±a</option>
            <option value="comment">Comentario</option>
            <option value="list">Lista</option>
          </select>

          <select class="filter-select" formControlName="category">
            <option value="">Todas las categor√≠as</option>
            <option value="content">Contenido</option>
            <option value="behavior">Comportamiento</option>
            <option value="spam">Spam</option>
            <option value="legal">Legal</option>
            <option value="safety">Seguridad</option>
          </select>

          <button type="button" class="search-btn" (click)="searchReports()">
            Buscar
          </button>

          <button type="button" class="action-btn btn-secondary" (click)="clearReportSearch()">
            Limpiar
          </button>
        </form>

        @if (loading.reports && reports.length === 0) {
        <div class="loading">
          <div class="loading-spinner"></div>
          <span>Cargando reportes...</span>
        </div>
        }

        @if (errors.reports) {
        <div class="error-message">
          {{ errors.reports }}
        </div>
        }

        @if (reports.length > 0) {
        <div class="reports-table-container">
          <table class="admin-table">
            <thead>
              <tr>
                <th>Reporter</th>
                <th>Usuario Reportado</th>
                <th>Contenido</th>
                <th>Motivo</th>
                <th>Prioridad</th>
                <th>Estado</th>
                <th>Fecha</th>
                <th>Acciones</th>
              </tr>
            </thead>
            <tbody>
              @for (report of reports; track report._id) {
              <tr>
                <!-- Reporter -->
                <td>
                  <div class="flex-center">
                    <img [src]="getUserAvatarPath(report.reporter.avatar)" alt="Avatar" class="user-avatar">
                    <div>
                      <div style="font-weight: 600; color: var(--text-primary);">{{ report.reporter.username }}</div>
                      <span class="status-badge" [ngClass]="getRoleClass(report.reporter.role)"
                        style="font-size: 0.65rem; margin-top: 2px;">
                        {{ report.reporter.role }}
                      </span>
                    </div>
                  </div>
                </td>

                <!-- Usuario reportado -->
                <td>
                  <div class="flex-center">
                    <img [src]="getUserAvatarPath(report.reportedUser.avatar)" alt="Avatar" class="user-avatar">
                    <div>
                      <div style="font-weight: 600; color: var(--text-primary);">{{ report.reportedUser.username }}
                      </div>
                      <span class="status-badge" [ngClass]="getRoleClass(report.reportedUser.role)"
                        style="font-size: 0.65rem; margin-top: 2px;">
                        {{ report.reportedUser.role }}
                      </span>
                    </div>
                  </div>
                </td>

                <!-- Contenido reportado -->
                <td>
                  <div>
                    <div style="font-weight: 600; color: var(--text-primary);">
                      {{ getContentTypeDisplayText(report.reportedContent.contentType) }}
                    </div>
                    @if (report.reportedContent.contentSnapshot) {
                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px; line-height: 1.3;">
                      @if (report.reportedContent.contentSnapshot.title) {
                      <div><strong>T√≠tulo:</strong> {{ report.reportedContent.contentSnapshot.title }}</div>
                      }
                      @if (report.reportedContent.contentSnapshot.text) {
                      <div><strong>Texto:</strong> {{ (report.reportedContent.contentSnapshot.text | slice:0:60) + '...'
                        }}
                      </div>
                      }
                      @if (report.reportedContent.contentSnapshot.rating) {
                      <div><strong>Puntuaci√≥n:</strong> {{ report.reportedContent.contentSnapshot.rating }}/10</div>
                      }
                    </div>
                    }
                  </div>
                </td>

                <!-- Motivo -->
                <td>
                  <div style="max-width: 150px;">
                    <div style="font-weight: 600; color: var(--text-primary); font-size: 0.85rem;">
                      {{ getReasonDisplayText(report.reason) }}
                    </div>
                    @if (report.description) {
                    <div style="font-size: 0.75rem; color: var(--text-secondary); margin-top: 2px; line-height: 1.3;"
                      [title]="report.description">
                      {{ (report.description | slice:0:50) + (report.description.length > 50 ? '...' : '') }}
                    </div>
                    }
                  </div>
                </td>

                <!-- Prioridad -->
                <td>
                  <span class="priority-badge" [ngClass]="getPriorityClass(report.priority)">
                    {{ capitalizeFirst(report.priority) }}
                  </span>
                </td>

                <!-- Estado -->
                <td>
                  <span class="status-badge" [ngClass]="getReportStatusClass(report.status)">
                    {{ getStatusDisplayText(report.status) }}
                  </span>
                  @if (report.resolution && report.resolution.resolvedBy) {
                  <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 2px;">
                    Por: {{ report.resolution.resolvedBy.username }}
                  </div>
                  }
                </td>

                <!-- Fecha -->
                <td>
                  <div style="font-size: 0.8rem; color: var(--text-primary);">
                    {{ formatDate(report.createdAt) }}
                  </div>
                  @if (report.resolution && report.resolution.resolvedAt) {
                  <div style="font-size: 0.7rem; color: var(--text-secondary); margin-top: 2px;">
                    Resuelto: {{ formatDate(report.resolution.resolvedAt) }}
                  </div>
                  }
                </td>

                <!-- Acciones -->
                <td>
                  <div class="actions-container">
                    @if (report.status === 'pending') {
                    <button class="action-btn btn-warning" (click)="updateReportStatus(report._id, 'under_review')"
                      title="Marcar en revisi√≥n">
                      <i class="bi bi-eye"></i>
                    </button>
                    }

                    @if (report.status !== 'resolved') {
                    <button class="action-btn btn-primary" (click)="openResolveReportModal(report)"
                      title="Resolver reporte">
                      <i class="bi bi-check-lg"></i>
                    </button>
                    }

                    @if (report.status !== 'dismissed') {
                    <button class="action-btn btn-secondary" (click)="updateReportStatus(report._id, 'dismissed')"
                      title="Descartar reporte">
                      <i class="bi bi-x-lg"></i>
                    </button>
                    }

                    <button class="action-btn btn-secondary" (click)="openReportDetailModal(report)"
                      title="Ver detalles">
                      <i class="bi bi-info-circle"></i>
                    </button>
                  </div>
                </td>
              </tr>
              }
            </tbody>
          </table>
        </div>

        @if (pagination.reports.hasMore) {
        <div class="pagination">
          <button class="load-more-btn" [disabled]="loading.reports" (click)="loadMoreReports()">
            @if (loading.reports) {
            Cargando...
            } @else {
            Cargar m√°s reportes
            }
          </button>
        </div>
        }
        } @else if (!loading.reports) {
        <div class="empty-state">
          <div class="empty-state-icon">üö©</div>
          <p>No se encontraron reportes</p>
        </div>
        }
      </div>
    </div>

    <!-- Settings Tab -->
    <div class="tab-content" [class.active]="tabState.activeTab === 'settings'" *ngIf="isAdmin">
      <div class="admin-card">
        <h3>Configuraci√≥n del Sistema</h3>
        <div style="text-align: center; padding: 60px 20px; color: var(--text-secondary);">
          <div style="font-size: 3rem; margin-bottom: 20px; opacity: 0.3;">‚öôÔ∏è</div>
          <p style="font-size: 1.1rem; margin-bottom: 10px;">Configuraciones avanzadas en desarrollo</p>
          <p style="font-size: 0.9rem;">Pr√≥ximamente: Configuraci√≥n global del sistema</p>
        </div>
      </div>
    </div>

  </div>
</div>

<!-- Modal de Ban -->
@if (showBanModal) {
<div class="modal-overlay" (click)="closeModals()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Banear Usuario</h3>
      <button class="close-btn" (click)="closeModals()">
        √ó
      </button>
    </div>

    <form [formGroup]="banForm" (ngSubmit)="banUser()">
      <div class="form-group">
        <label>Usuario:</label>
        <input type="text" [value]="modalData.username" readonly>
      </div>

      <div class="form-group">
        <label>Raz√≥n del ban: *</label>
        <textarea formControlName="reason" placeholder="Describe la raz√≥n del ban..." required rows="3"></textarea>
        @if (banForm.get('reason')?.errors && banForm.get('reason')?.touched) {
        <div style="color: var(--color-error); font-size: 0.8rem; margin-top: 8px;">
          La raz√≥n es obligatoria y debe tener al menos 10 caracteres
        </div>
        }
      </div>

      <div class="form-group">
        <label>Duraci√≥n del ban:</label>
        <select formControlName="duration">
          <option value="">Permanente (sin expiraci√≥n)</option>
          <option value="1">1 hora (temporal)</option>
          <option value="24">24 horas (1 d√≠a)</option>
          <option value="168">7 d√≠as (1 semana)</option>
          <option value="720">30 d√≠as (1 mes)</option>
        </select>
        <div class="form-help">
          @if (banForm.get('duration')?.value) {
          <span style="color: var(--color-warning);">
            Ban temporal: {{ getBanDurationText(banForm.get('duration')?.value) }}
          </span>
          } @else {
          <span style="color: var(--color-error);">
            Ban permanente: El usuario no podr√° acceder nunca m√°s
          </span>
          }
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="action-btn btn-secondary" (click)="closeModals()">
          Cancelar
        </button>
        <button type="submit" class="action-btn btn-danger" [disabled]="banForm.invalid || loading.banning">
          @if (loading.banning) {
          Baneando...
          } @else {
          Banear Usuario
          }
        </button>
      </div>
    </form>
  </div>
</div>
}




<!-- Modal para resolver reporte -->
@if (showResolveReportModal) {
<div class="modal-overlay" (click)="closeReportModals()">
  <div class="modal-content modal-large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Resolver Reporte</h3>
      <button class="close-btn" (click)="closeReportModals()">
        √ó
      </button>
    </div>

    <form [formGroup]="resolveReportForm" (ngSubmit)="resolveReport()">
      @if (modalData.report) {
      <!-- Informaci√≥n del reporte -->
      <div
        style="background: var(--bg-surface); padding: var(--spacing-lg); border-radius: var(--radius-md); margin-bottom: var(--spacing-lg);">
        <div
          style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg); margin-bottom: var(--spacing-md);">
          <div>
            <strong>Reporter:</strong> {{ modalData.report.reporter.username }}
          </div>
          <div>
            <strong>Usuario reportado:</strong> {{ modalData.report.reportedUser.username }}
          </div>
        </div>

        <div
          style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg); margin-bottom: var(--spacing-md);">
          <div>
            <strong>Tipo:</strong> {{ getContentTypeDisplayText(modalData.report.reportedContent.contentType) }}
          </div>
          <div>
            <strong>Motivo:</strong> {{ getReasonDisplayText(modalData.report.reason) }}
          </div>
        </div>

        @if (modalData.report.description) {
        <div style="margin-bottom: var(--spacing-md);">
          <strong>Descripci√≥n:</strong>
          <div
            style="background: var(--bg-input); padding: var(--spacing-sm); border-radius: var(--radius-sm); margin-top: var(--spacing-xs);">
            {{ modalData.report.description }}
          </div>
        </div>
        }

        @if (modalData.report.reportedContent.contentSnapshot) {
        <div>
          <strong>Contenido reportado:</strong>
          <div
            style="background: var(--bg-input); padding: var(--spacing-sm); border-radius: var(--radius-sm); margin-top: var(--spacing-xs);">
            @if (modalData.report.reportedContent.contentSnapshot.title) {
            <div><strong>T√≠tulo:</strong> {{ modalData.report.reportedContent.contentSnapshot.title }}</div>
            }
            @if (modalData.report.reportedContent.contentSnapshot.text) {
            <div><strong>Texto:</strong> {{ modalData.report.reportedContent.contentSnapshot.text }}</div>
            }
            @if (modalData.report.reportedContent.contentSnapshot.rating) {
            <div><strong>Puntuaci√≥n:</strong> {{ modalData.report.reportedContent.contentSnapshot.rating }}/10</div>
            }
          </div>
        </div>
        }
      </div>
      }

      <div class="form-group">
        <label>Acci√≥n a tomar: *</label>
        <select formControlName="action" required>
          <option value="">Seleccionar acci√≥n</option>
          <option value="no_action">Sin acci√≥n</option>
          <option value="content_deleted">Contenido eliminado</option>
          <option value="user_warned">Usuario advertido</option>
          <option value="user_banned">Usuario baneado</option>
          <option value="other">Otra acci√≥n</option>
        </select>
      </div>

      <div class="form-group">
        <label>Notas de resoluci√≥n:</label>
        <textarea formControlName="notes" placeholder="Describe la acci√≥n tomada y el motivo..." rows="4"></textarea>
      </div>

      <div class="form-group">
        <label style="display: flex; align-items: center; gap: var(--spacing-sm);">
          <input type="checkbox" formControlName="shouldNotify" style="margin: 0;">
          Enviar notificaci√≥n al usuario reportado
        </label>
      </div>

      <div class="form-actions">
        <button type="button" class="action-btn btn-secondary" (click)="closeReportModals()">
          Cancelar
        </button>
        <button type="submit" class="action-btn btn-primary"
          [disabled]="resolveReportForm.invalid || loading.resolvingReport">
          @if (loading.resolvingReport) {
          Resolviendo...
          } @else {
          Resolver Reporte
          }
        </button>
      </div>
    </form>
  </div>
</div>
}

<!-- Modal para ver detalles del reporte -->
@if (showReportDetailModal) {
<div class="modal-overlay" (click)="closeReportModals()">
  <div class="modal-content modal-large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Detalles del Reporte</h3>
      <button class="close-btn" (click)="closeReportModals()">
        √ó
      </button>
    </div>

    @if (modalData.report) {
    <div style="padding: var(--spacing-lg);">
      <!-- Informaci√≥n b√°sica -->
      <div
        style="display: grid; grid-template-columns: 1fr 1fr; gap: var(--spacing-lg); margin-bottom: var(--spacing-xl);">
        <div>
          <h4>Reporter</h4>
          <div class="flex-center" style="gap: var(--spacing-md);">
            <img [src]="getUserAvatarPath(modalData.report.reporter.avatar)" alt="Avatar" class="user-avatar">
            <div>
              <div style="font-weight: 600;">{{ modalData.report.reporter.username }}</div>
              <span class="status-badge" [ngClass]="getRoleClass(modalData.report.reporter.role)">
                {{ modalData.report.reporter.role }}
              </span>
            </div>
          </div>
        </div>

        <div>
          <h4>Usuario Reportado</h4>
          <div class="flex-center" style="gap: var(--spacing-md);">
            <img [src]="getUserAvatarPath(modalData.report.reportedUser.avatar)" alt="Avatar" class="user-avatar">
            <div>
              <div style="font-weight: 600;">{{ modalData.report.reportedUser.username }}</div>
              <span class="status-badge" [ngClass]="getRoleClass(modalData.report.reportedUser.role)">
                {{ modalData.report.reportedUser.role }}
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Detalles del reporte -->
      <div style="margin-bottom: var(--spacing-xl);">
        <h4>Detalles del Reporte</h4>
        <div style="background: var(--bg-surface); padding: var(--spacing-lg); border-radius: var(--radius-md);">
          <div
            style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: var(--spacing-lg); margin-bottom: var(--spacing-md);">
            <div>
              <strong>Tipo:</strong> {{ getContentTypeDisplayText(modalData.report.reportedContent.contentType) }}
            </div>
            <div>
              <strong>Motivo:</strong> {{ getReasonDisplayText(modalData.report.reason) }}
            </div>
            <div>
              <strong>Prioridad:</strong>
              <span class="priority-badge" [ngClass]="getPriorityClass(modalData.report.priority)">
                {{ capitalizeFirst(modalData.report.priority) }}
              </span>
            </div>
          </div>

          <div style="margin-bottom: var(--spacing-md);">
            <strong>Estado:</strong>
            <span class="status-badge" [ngClass]="getReportStatusClass(modalData.report.status)">
              {{ getStatusDisplayText(modalData.report.status) }}
            </span>
          </div>

          @if (modalData.report.description) {
          <div style="margin-bottom: var(--spacing-md);">
            <strong>Descripci√≥n del reporter:</strong>
            <div
              style="background: var(--bg-input); padding: var(--spacing-sm); border-radius: var(--radius-sm); margin-top: var(--spacing-xs);">
              {{ modalData.report.description }}
            </div>
          </div>
          }

          <div style="margin-bottom: var(--spacing-md);">
            <strong>Fecha del reporte:</strong> {{ formatDate(modalData.report.createdAt) }}
          </div>
        </div>
      </div>

      <!-- Contenido reportado -->
      @if (modalData.report.reportedContent.contentSnapshot) {
      <div style="margin-bottom: var(--spacing-xl);">
        <h4>Contenido Reportado</h4>
        <div style="background: var(--bg-surface); padding: var(--spacing-lg); border-radius: var(--radius-md);">
          @if (modalData.report.reportedContent.contentSnapshot.title) {
          <div style="margin-bottom: var(--spacing-sm);">
            <strong>T√≠tulo:</strong> {{ modalData.report.reportedContent.contentSnapshot.title }}
          </div>
          }
          @if (modalData.report.reportedContent.contentSnapshot.text) {
          <div style="margin-bottom: var(--spacing-sm);">
            <strong>Texto:</strong>
            <div
              style="background: var(--bg-input); padding: var(--spacing-sm); border-radius: var(--radius-sm); margin-top: var(--spacing-xs); white-space: pre-wrap;">
              {{ modalData.report.reportedContent.contentSnapshot.text }}</div>
          </div>
          }
          @if (modalData.report.reportedContent.contentSnapshot.rating) {
          <div style="margin-bottom: var(--spacing-sm);">
            <strong>Puntuaci√≥n:</strong> {{ modalData.report.reportedContent.contentSnapshot.rating }}/10
          </div>
          }
        </div>
      </div>
      }

      <!-- Resoluci√≥n (si existe) -->
      @if (modalData.report.resolution) {
      <div>
        <h4>Resoluci√≥n</h4>
        <div style="background: var(--bg-surface); padding: var(--spacing-lg); border-radius: var(--radius-md);">
          <div style="margin-bottom: var(--spacing-sm);">
            <strong>Acci√≥n:</strong> {{ getActionDisplayText(modalData.report.resolution.action) }}
          </div>
          <div style="margin-bottom: var(--spacing-sm);">
            <strong>Resuelto por:</strong> {{ modalData.report.resolution.resolvedBy.username }}
          </div>
          <div style="margin-bottom: var(--spacing-sm);">
            <strong>Fecha de resoluci√≥n:</strong> {{ formatDate(modalData.report.resolution.resolvedAt) }}
          </div>
          @if (modalData.report.resolution.notes) {
          <div>
            <strong>Notas:</strong>
            <div
              style="background: var(--bg-input); padding: var(--spacing-sm); border-radius: var(--radius-sm); margin-top: var(--spacing-xs);">
              {{ modalData.report.resolution.notes }}
            </div>
          </div>
          }
        </div>
      </div>
      }
    </div>
    }

    <div class="form-actions">
      <button type="button" class="action-btn btn-secondary" (click)="closeReportModals()">
        Cerrar
      </button>
    </div>
  </div>
</div>
}

<!-- Modal de Historial de Moderaci√≥n -->
@if (showHistoryModal) {
<div class="modal-overlay" (click)="closeModals()">
  <div class="modal-content modal-history" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Historial de Moderaci√≥n - {{ modalData.username }}</h3>
      <button class="close-btn" (click)="closeModals()">
        √ó
      </button>
    </div>

    @if (modalData.moderationHistory && modalData.moderationHistory.length > 0) {
    <div class="history-list">
      @for (item of modalData.moderationHistory; track $index) {
      <div class="history-item">
        <div class="history-header">
          <span class="history-action">{{ getActionText(item.action) }}</span>
          <span class="history-date">{{ formatDate(item.date) }}</span>
        </div>
        <div class="history-moderator">
          Moderador: <strong>{{ item.moderator }}</strong>
        </div>
        @if (item.reason) {
        <div class="history-reason">
          <strong>Raz√≥n:</strong> {{ item.reason }}
        </div>
        }
        @if (item.duration) {
        <div class="history-reason">
          <strong>Duraci√≥n:</strong> {{ item.duration }}
        </div>
        }
      </div>
      }
    </div>
    } @else {
    <div class="empty-state">
      <div class="empty-state-icon">üìù</div>
      <p>No hay historial de moderaci√≥n para este usuario</p>
    </div>
    }

    <div class="form-actions">
      <button type="button" class="action-btn btn-secondary" (click)="closeModals()">
        Cerrar
      </button>
    </div>
  </div>
</div>
}

<!-- Modal de Ver Rese√±a Completa -->
@if (showReviewModal) {
<div class="modal-overlay" (click)="closeModals()">
  <div class="modal-content modal-large" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Rese√±a Completa</h3>
      <button class="close-btn" (click)="closeModals()">
        √ó
      </button>
    </div>

    @if (modalData.review) {
    <div style="margin-bottom: 20px;">
      <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px;">
        <img [src]="getUserAvatarPath(modalData.review.userId.avatar)" alt="Avatar" class="user-avatar">
        <div>
          <div style="font-weight: 600; color: var(--text-primary);">{{ modalData.review.userId.username }}</div>
          <div style="font-size: 0.8rem; color: var(--text-secondary);">
            {{ formatDate(modalData.review.createdAt) }}
          </div>
        </div>
        <div style="margin-left: auto;">
          <span style="color: var(--color-warning); font-weight: 600; font-size: 1.2rem;">
            {{ modalData.review.rating }}/10
          </span>
        </div>
      </div>

      <div style="margin-bottom: 16px;">
        <strong>Pel√≠cula ID:</strong> {{ modalData.review.movieId }}
      </div>

      <div style="margin-bottom: 16px;">
        <strong>Comentario:</strong>
      </div>

      <div class="review-content">
        {{ modalData.review.comment }}
      </div>
    </div>
    }

    <div class="form-actions">
      <button type="button" class="action-btn btn-secondary" (click)="closeModals()">
        Cerrar
      </button>
      <button type="button" class="action-btn btn-danger"
        (click)="openDeleteModal('review', modalData.review._id, 'Rese√±a de ' + modalData.review.userId.username)">
        Eliminar Rese√±a
      </button>
    </div>
  </div>
</div>
}

<!-- Modal de Cambio de Rol -->
@if (showRoleModal) {
<div class="modal-overlay" (click)="closeModals()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Cambiar Rol</h3>
      <button class="close-btn" (click)="closeModals()">
        √ó
      </button>
    </div>

    <form [formGroup]="roleForm" (ngSubmit)="changeUserRole()">
      <div class="form-group">
        <label>Usuario:</label>
        <input type="text" [value]="modalData.username" readonly>
      </div>

      <div class="form-group">
        <label>Rol actual:</label>
        <div style="display: flex; align-items: center; gap: 8px;">
          <span class="status-badge" [ngClass]="getRoleClass(modalData.currentRole || '')">
            {{ modalData.currentRole }}
          </span>
        </div>
      </div>

      <div class="form-group">
        <label>Nuevo rol: *</label>
        <select formControlName="newRole" required>
          <option value="">Seleccionar rol</option>
          <option value="user">Usuario</option>
          <option value="premium">Premium</option>
          <option value="moderator">Moderador</option>
          <option value="admin">Administrador</option>
        </select>
        @if (roleForm.get('newRole')?.value) {
        <div class="form-help">
          <span class="status-badge" [ngClass]="getRoleClass(roleForm.get('newRole')?.value)">
            Nuevo rol: {{ roleForm.get('newRole')?.value }}
          </span>
        </div>
        }
      </div>

      <div class="form-group">
        <label>Raz√≥n del cambio:</label>
        <textarea formControlName="reason" placeholder="Raz√≥n para el cambio de rol (opcional)..." rows="2"></textarea>
      </div>

      <div class="form-actions">
        <button type="button" class="action-btn btn-secondary" (click)="closeModals()">
          Cancelar
        </button>
        <button type="submit" class="action-btn btn-primary" [disabled]="roleForm.invalid">
          Cambiar Rol
        </button>
      </div>
    </form>
  </div>
</div>
}

<!-- Modal de Eliminaci√≥n -->
@if (showDeleteModal) {
<div class="modal-overlay" (click)="closeModals()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Eliminar {{ capitalizeFirst(modalData.itemType || '') }}</h3>
      <button class="close-btn" (click)="closeModals()">
        √ó
      </button>
    </div>

    <form [formGroup]="deleteForm" (ngSubmit)="deleteContent()">
      <div style="margin-bottom: 20px;">
        <div
          style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
          <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px;">
            <span style="color: var(--color-warning);">‚ö†Ô∏è</span>
            <strong style="color: var(--color-warning);">¬øEst√°s seguro de que quieres eliminar?</strong>
          </div>
          <p style="margin: 0; color: var(--text-primary);">{{ modalData.itemTitle }}</p>
        </div>

        <div
          style="background: rgba(255, 68, 68, 0.1); border: 1px solid rgba(255, 68, 68, 0.3); border-radius: 8px; padding: 12px;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <span style="color: var(--color-error);">‚ùå</span>
            <span style="color: var(--color-error); font-size: 14px; font-weight: 600;">
              Esta acci√≥n no se puede deshacer
            </span>
          </div>
        </div>
      </div>

      <div class="form-group">
        <label>Raz√≥n de la eliminaci√≥n (opcional):</label>
        <textarea formControlName="reason" placeholder="Describe la raz√≥n de la eliminaci√≥n..." rows="3"></textarea>
      </div>

      <div class="form-actions">
        <button type="button" class="action-btn btn-secondary" (click)="closeModals()">
          Cancelar
        </button>
        <button type="submit" class="action-btn btn-danger">
          Eliminar Definitivamente
        </button>
      </div>
    </form>
  </div>
</div>
}